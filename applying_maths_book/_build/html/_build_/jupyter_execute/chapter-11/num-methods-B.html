
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Numerical solution of differential equations &#8212; Applying Maths in the Chemical &amp; Biomolecular Sciences</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../_static/book-cover.jpg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Applying Maths in the Chemical & Biomolecular Sciences</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../intro.html">
   Applying Maths in the Chemical and Biomolecular Sciences.
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../chapter-1/chapter1-intro.html">
   1. Numbers, Equations, Operators, and Algorithms.
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-1/chapter1-A.html">
     Numbers to Algorithms.
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-1/chapter1-Q1-7.html">
     Questions 1 - 7
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-1/chapter1-B.html">
     Trig, hyperbolic and inverse functions, waves, polar coordinates &amp; factorials
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-1/chapter1-Q8-16.html">
     Questions 8 - 16
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-1/chapter1-C.html">
     Sophisticated Counting.
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-1/chapter1-Q17-34.html">
     Questions 17 - 34
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-1/chapter1-D.html">
     Modulo arithmetic,
     <span class="math notranslate nohighlight">
      \(\delta\)
     </span>
     functions, types of  series &amp;  estimating quantities
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-1/chapter1-Q35-39.html">
     Questions 35 - 39
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-1/chapter1-answers-1-7.html">
     Solutions Q1 - 7
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-1/chapter1-answers-8-16.html">
     Solutions Q8 - 16
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-1/chapter1-answers-17-34.html">
     Solutions Q17 - 34
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-1/chapter1-answers-35-39.html">
     Solutions Q35 - 39
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../chapter-2/chapter2-intro.html">
   2. Complex numbers.
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-2/chapter2-A.html">
     Real, imaginary, conjugate and modulus
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-2/chapter2-Q-1-9.html">
     Questions 1 - 9
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-2/chapter2-B.html">
     De Moivre’s theorem and integer powers of complex numbers
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-2/chapter2-Q-10-13.html">
     Questions 10 -13
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-2/chapter2-C.html">
     Euler’s theorem
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-2/chapter2-Q-14-27.html">
     Questions 14 - 27
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-2/chapter2-answers.html">
     Solutions Q1 - 27
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../chapter-3/differen-intro.html">
   3. Differentiation.
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-A.html">
     Differentiation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-B.html">
     Trig functions, logs, power, reciprocals and integrals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-C-Q-4-11.html">
     Questions 1-11
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-D.html">
     Product rule and function of function or chain rule.
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-E-Q-12-42.html">
     Questions 12-42
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-F.html">
     Limits, l’Hopital’s rule, Maximum, Minimum and Calculus of Variations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-G-Q-43-73.html">
     Questions 43 - 73
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-H.html">
     Numerically finding the roots of an equation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-I-Q-74-85.html">
     Questions 74 - 85
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-J.html">
     Minimizing or maximizing with constraints: Lagrange Undetermined Multipliers
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-K-Q-86-92.html">
     Questions 86 - 92
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-L.html">
     Partial differentiation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-M-Q-93-114.html">
     Questions 93-114
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-M1.html">
     Differentiation of vectors
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-N-answers-1-11.html">
     Solutions Q 1-11
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-O-answers-12-42.html">
     Solutions Q 12-42
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-P-answers-43-73.html">
     Solutions Q 43 - 73
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-Q-answers-74-85.html">
     Solutions Q 74 - 85
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-R-answers-86-92.html">
     Solutions Q 86 - 94
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-3/differen-S-answers-93-114.html">
     Solutions Q 93-114
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../chapter-4/integration-intro.html">
   4. Integration.
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-A.html">
     Integration basics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-Q1-14.html">
     Questions 1-14
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-B.html">
     Integration by substitution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-Q15-30.html">
     Questions 15-30
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-C.html">
     Using parametric equations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-Q31-48.html">
     Questions 31 - 48
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-D.html">
     Calculating an Average Value.
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-Q49-72.html">
     Questions 49 - 72
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-E.html">
     The Variational Method in Quantum Mechanics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-Q73-77.html">
     Questions 73 - 77
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-F.html">
     Multiple integrals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-Q78-86.html">
     Questions 78 - 86
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-G.html">
     Calculating the energy of a chemical bond using molecular orbitals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-H.html">
     Line integrals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-Q87-96.html">
     Questions 87 - 96
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-answers-1-14.html">
     Solutions Q1 - 14
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-answers-15-30.html">
     Solutions Q15 - 30
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-answers-31-48.html">
     Solutions Q31 - 48
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-answers-49-72.html">
     Solutions Q49 - 72
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-4/integration-answers-73-96.html">
     Solutions Q73 - 96
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../chapter-5/chapter-5-intro.html">
   5. Summations, Series and expansion of Functions.
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-5/chapter-5-A.html">
     Series, averages, partition functions, DNA melting, atom entropy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-5/chapter-5-B-Q1-13.html">
     Questions 1 - 13
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-5/chapter-5-E.html">
     Maclaurin and Taylor series expansions. Paramagnetic spins. Euler-Maclaurin formula.
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-5/chapter-5-F-Q14-34.html">
     Questions 14 - 34
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-5/chapter-5-G-Q35-44.html">
     Questions 35 - 44
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-5/chapter-5-perturbation-A.html">
     Perturbation Theory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-5/chapter-5-perturbation-B-Q45-48.html">
     Questions 45 - 48
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-5/chapter-5-perturbation-C.html">
     Quantum superposition and wavepackets.
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-5/chapter-5-perturbation-D-Q49-52.html">
     Questions 49 - 52
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-5/chapter-5-answers-1-7.html">
     Solutions Q 1 - 7
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-5/chapter-5-answers-8-13.html">
     Solutions Q8 - 13
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-5/chapter-5-answers-14-26.html">
     Solutions Q 14 - 26
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-5/chapter-5-answers-27-32.html">
     Solutions Q27 - 34
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-5/chapter-5-answers-33-44.html">
     Solutions Q33 - 44
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-5/chapter-5-answers-45-52.html">
     Solutions Q45 - 52
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../chapter-6/vectors-intro.html">
   6. Vectors.
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-A.html">
     Vector basics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-Q1-24.html">
     Questions 1 - 24
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-B.html">
     Projections and components
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-Q25-32.html">
     Questions 25 - 32
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-C.html">
     Axes need not be right-angled or of equal length
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-Q33-38.html">
     Questions 33 - 38
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-D.html">
     Basis sets with more than three dimensions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-Q39-46.html">
     Questions 39 - 46
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-E.html">
     Cross product or vector product
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-Q47-52.html">
     Questions 47 - 52
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-F.html">
     Torsion or dihedral angles
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-Q53-48.html">
     Questions 53 - 48
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-G.html">
     Torque and angular momentum
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-Q59-61.html">
     Questions 59 - 61
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-answers-Q1-24.html">
     Solutions Q1 - 24
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-answers-Q25-32.html">
     Solutions Q25 - 32
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-answers-Q33-38.html">
     Solutions Q33 - 38
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-answers-Q39-46.html">
     Solutions Q39 - 46
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-answers-Q47-52.html">
     Solutions Q47 - 52
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-6/vectors-answers-Q53-61.html">
     Solutions Q53 - 61
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../chapter-7/matrices-intro.html">
   7. Matrices
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-A.html">
     Determinants
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-Q1-10.html">
     Questions  1 - 10
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-B.html">
     Matrices
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-Q11-16.html">
     Questions  11 - 16
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-C.html">
     Molecular Group Theory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-Q17-30.html">
     Questions  17 - 30
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-D.html">
     Rotation matrices: moving molecules
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-Q31-34.html">
     Questions 31 - 34
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-E.html">
     Matrices in optics and designing laser cavities
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-Q35-39.html">
     Questions 35 - 39
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-F.html">
     Polarizing optics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-Q40-44.html">
     Questions 40 - 44
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-G.html">
     Solving equations using matrices. Eigenvectors &amp; Eigenvalues.
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-Q45-50.html">
     Questions 45 - 50
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-H.html">
     Rate equations and Chemical Kinetics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-Q51-54.html">
     Questions 51 - 54
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-I.html">
     Molecular vibrations and pendulums
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-Q55-58.html">
     Questions 55 - 58
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-J.html">
     Moments of Inertia
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-Q59-60.html">
     Questions 59 - 62
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-K.html">
     Calculating a bond length using moments of inertia
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-Q61.html">
     Question 61
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-L.html">
     Principal axes for Moments of Inertia
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-Q62.html">
     Question 62
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-answersQ1-10.html">
     Solutions Q1 - 10
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-answersQ11-16.html">
     Solutions Q11 - 16
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-answersQ17-30.html">
     Solutions Q17 - 30
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-answersQ31-34.html">
     Solutions Q31 - 34
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-answersQ35-39.html">
     Solutions Q35 - 39
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-answersQ40-44.html">
     Solutions Q40 - 44
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-answersQ45-50.html">
     Solutions Q45 - 50
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-answersQ51-54.html">
     Solutions Q51 - 54
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-answersQ55-58.html">
     Solutions Q55 - 58
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-7/matrices-answersQ59-61.html">
     Solutions Q59 - 61
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../chapter-8/matricesQM-intro.html">
   8. Matrices in Quantum Mechanics
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-8/matricesQM-A.html">
     Matrices in Quantum Mechanics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-8/matricesQM-Q1-7.html">
     Questions 1 - 7
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-8/matricesQM-B.html">
     Basis sets and bra-ket algebra
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-8/matricesQM-Q8-12.html">
     Questions 8 - 12
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-8/matricesQM-C.html">
     Continuous basis sets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-8/matricesQM-answers1-7.html">
     Solutions Q1 - 7
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-8/matricesQM-answers8-12.html">
     Solutions Q8 - 12
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../chapter-9/Fourier-intro.html">
   9. Fourier Series and Transforms.
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-9/Fourier-A-B.html">
     Fourier series, Gibbs phenomenon, generalised series.
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-9/Fourier-questions-1-6.html">
     Questions 1 - 6
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-9/Fourier-C.html">
     Fourier Transforms
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-9/Fourier-questions-7-15.html">
     Questions 7 - 15
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-9/Fourier-D.html">
     Convolution and Autocorrelation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-9/Fourier-questions-16-21.html">
     Questions 16 - 21
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-9/Fourier-E.html">
     Discrete Fourier  (DFT)  and Fast Fourier transforms (FFT)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-9/Fourier-F.html">
     The Hadamard Transform: Encoding and Decoding
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-9/Fourier-answers-1-6.html">
     Solutions Q 1 - 6
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-9/Fourier-answers-7-15.html">
     Solutions Q 7 - 15
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-9/Fourier-answers-16-21.html">
     Solutions Q 16 - 21
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-9/Fourier-2D-Diffraction.html">
     The Fourier transform in two dimensions: images and x-ray Diffraction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-9/Fourier-tomography.html">
     Computed Tomography
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../chapter-10/Diff-eqns-intro.html">
   10. Differential Equations.
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-10/Diff-eqns-A.html">
     Differential Equations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-10/Diff-eqns-Q1-23.html">
     Questions 1 - 23
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-10/Diff-eqns-B.html">
     First order eqns &amp; Integrating factors. Second order eqns, Newtons laws, equations of motion.
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-10/Diff-eqns-C.html">
     The ‘D’ operator.  Solving linear differential equations with constant coefficients
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-10/Diff-eqns-D.html">
     Simultaneous equations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-10/Diff-eqns-Q24-37.html">
     Questions 24 - 37
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-10/Diff-eqns-E.html">
     Linear equations with variable coefficients
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-10/Diff-eqns-F.html">
     Partial Differential Equations, PDE
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-10/Diff-eqns-G.html">
     PDE examples continued
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-10/Diff-eqns-answers-1-21.html">
     Solutions Q1 - 21
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-10/Diff-eqns-answers-22-37.html">
     Solutions Q22 - 37
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../chapter-11/num-methods-intro.html">
   11. Numerical Methods
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-A.html">
     Numerical Methods
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-Q1-7.html">
     Questions 1 - 7
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-B.html">
     Numerical solution of differential equations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-Q8-12.html">
     Questions 8 - 12
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-C.html">
     Coupled equations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-Q13-16.html">
     Questions 13 - 16
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-D.html">
     The phase plane, nullclines, and stable points
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-Q17-20.html">
     Questions 17 - 20
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-E.html">
     Reaction schemes with feedback
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-Q21-34.html">
     Questions 21 - 34
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-F.html">
     Boundary value problems.
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-Q35-40.html">
     Questions 35 - 40
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-answers1-7.html">
     Solutions Q1 - 7
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-answers8-12.html">
     Solutions Q8 - 12
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-answers13-16.html">
     Solutions Q13 - 16
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-answers17-20.html">
     Solutions Q17 - 20
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-answers21-34.html">
     Solutions Q21 - 34
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-11/num-methods-answers35-40.html">
     Solutions Q35 - 40
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../chapter-12/monte-carlo-intro.html">
   12. Monte Carlo Methods
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-12/monte-carlo-A.html">
     Monte - Carlo Methods
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-12/monte-carlo-Q1-6.html">
     Questions 1 - 6
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-12/monte-carlo-B.html">
     Solving rate equations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-12/monte-carlo-Q7-10.html">
     Questions 7 - 10
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-12/monte-carlo-CC.html">
     Monte Carlo Simulations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-12/monte-carlo-C.html">
     Energy transfer. Autocatalytic reaction and spreading of fires
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-12/monte-carlo-Q11-17.html">
     Questions 11 - 17
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-12/monte-carlo-D.html">
     The Metropolis algorithm
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-12/monte-carlo-answers1-6.html">
     Solutions Q1 - 6
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-12/monte-carlo-answers7-10.html">
     Solutions Q7 - 10
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-12/monte-carlo-answers11-17.html">
     Solutions Q11 - 17
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../chapter-13/analysis-intro.html">
   13. Data Analysis
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
  <label for="toctree-checkbox-13">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-13/analysis-A.html">
     Characterizing experimental data. Accuracy, precision, mean and standard deviation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-13/analysis-Q1-3.html">
     Questions 1 - 3
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-13/analysis-B.html">
     Modelling data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-13/analysis-Q4-9.html">
     Questions 4 - 9
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-13/analysis-C.html">
     Modelling data is simpler using matrices
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-13/analysis-Q10-11.html">
     Questions 10 - 13
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-13/analysis-D.html">
     Non-linear least squares. Least absolute deviation. Principal component analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../chapter-13/analysis-answers1-11.html">
     Solutions Q1 -11
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../chapter-1/chapter1-E.html">
   SI units, Rounding, converting units &amp; Glossary.
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../references/References.html">
   References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../references/Python%20crib.html">
   Appendix:  Some basic Python instructions with a few examples.
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../_sources/_build_/jupyter_execute/chapter-11/num-methods-B.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/_build_/jupyter_execute/chapter-11/num-methods-B.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#euler-s-and-other-methods-of-numerical-approximation">
   4.1 Euler’s and other methods of numerical approximation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#errors">
   4. 2 Errors
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-euler-s-method">
   4.3 Using Euler’ s method
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#improving-on-the-euler-method">
   4.4 Improving on the Euler method
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#modified-euler-or-heun-s-method">
     <strong>
      Modified Euler or Heun’s method
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#runge-kutta-method">
     <strong>
      Runge - Kutta method
     </strong>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#verlet-algorithm-calculating-dynamics-and-performing-md-simulations">
   4.6 Verlet algorithm: calculating dynamics and performing MD simulations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#molecular-dynamics-simulations">
   4.7 Molecular dynamics simulations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#other-verlet-algorithms">
   4.8 Other Verlet algorithms
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#basic-verlet-algorithm">
   4.9 Basic Verlet Algorithm
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-verlet-algorithm-used-to-calculate-atom-scattering-trajectories">
   4.10 The Verlet algorithm used to calculate atom scattering trajectories
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-numerical-solution-of-the-diffusion-equation-illustrated-with-transient-grating-decay">
   4.10a  Numerical solution of the Diffusion equation illustrated with transient grating decay.
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#initial-conditions">
     <strong>
      Initial Conditions
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-calculation-decay-of-transient-grating-see-also-chapter-10-10">
     <strong>
      Example Calculation: Decay of Transient Grating. (See also chapter 10.10.)
     </strong>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#crank-nicholson-method">
   Crank-Nicholson Method
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#d-diffusion-in-a-plate">
   2D diffusion in a plate.
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="numerical-solution-of-differential-equations">
<h1>Numerical solution of differential equations<a class="headerlink" href="#numerical-solution-of-differential-equations" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import all python add-ons etc that will be needed later on</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">linalg</span>                <span class="c1"># import library to invert matrices</span>
<span class="n">init_printing</span><span class="p">()</span>                         <span class="c1"># print SymPy results in typeset maths format</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">})</span>  <span class="c1"># set font size for plots</span>
</pre></div>
</div>
</div>
</div>
<p>Although many differential equations can be explicitly integrated, as illustrated in Chapter 10, there are many others of interest, particularly in quantum mechanics, that have no such solution other than by a series expansion and even this may only be approximate. In these cases a numerical solution must be sought; however, this is always preceded by as much algebraic analysis of the problem as is possible.</p>
<p>As with any integration, a constant is produced for each integration step; two constants are necessary for an equation with derivative <span class="math notranslate nohighlight">\(d^2y/dx^2\)</span> because two integrations are necessary to produce <span class="math notranslate nohighlight">\(y\)</span>. In differential equations, integration constants are found by using the initial values and/or the boundary values to <span class="math notranslate nohighlight">\(y\)</span> and its derivatives, and these are determined by the particular problem being solved. These are described in Chapter 10.</p>
<div class="section" id="euler-s-and-other-methods-of-numerical-approximation">
<h2>4.1 Euler’s and other methods of numerical approximation<a class="headerlink" href="#euler-s-and-other-methods-of-numerical-approximation" title="Permalink to this headline">¶</a></h2>
<p>The analytic or algebraic solution to an equation produces a function whose values are continuous in <span class="math notranslate nohighlight">\(x,\, y\)</span>, or <span class="math notranslate nohighlight">\(t\)</span>, and that allows us to calculate its value at any point we might choose, there being, effectively, an infinite number to choose from. A general feature of the numerical solution of a differential equation is that it is converted into recursive finite - difference equation and this is because a numerical solution can be obtained only at relatively few discrete values. The general first-order differential equation is</p>
<div class="math notranslate nohighlight">
\[\displaystyle \frac{dy}{dt}=f(t,y)  \tag{16}\]</div>
<p>which means that <span class="math notranslate nohighlight">\(f(t, y)\)</span> is a function of <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(t\)</span> such as <span class="math notranslate nohighlight">\(te^{-t} + y + 3\)</span>. The initial condition is <span class="math notranslate nohighlight">\(y(t_0) = y_0\)</span>. The differential has to be approximated in some way, because we can only evaluate at discrete points, and the simplest way to do this is to write</p>
<div class="math notranslate nohighlight">
\[\displaystyle  \frac{\Delta y}{\Delta t}\approx \frac{dy}{dt}=f(t,y)  \tag{17}\]</div>
<p>If <span class="math notranslate nohighlight">\(\Delta t=t_{n+1}-t_n \equiv h\)</span> is small enough, then this first-order approximation is a good one. The change in <span class="math notranslate nohighlight">\(y\)</span> is calculated similarly,</p>
<div class="math notranslate nohighlight">
\[\displaystyle  \frac{\Delta y}{\Delta t}= \frac{y_{n+1}-y_n}{h}\approx f(t_n,y_n)  \tag{18}\]</div>
<p>Rearranging gives the Euler method equations</p>
<div class="math notranslate nohighlight">
\[\displaystyle  y_{n+1}=y_n+hf(t_n,y_n)  \tag{19a}\]</div>
<div class="math notranslate nohighlight">
\[\displaystyle  y_0=y(t_0), \qquad t_n=t_0+nh, \qquad n=0,\,1,\,2\cdots N-1 \tag{19b}\]</div>
<p>The <span class="math notranslate nohighlight">\(n^{th}\)</span> value of <span class="math notranslate nohighlight">\(t\)</span> is <span class="math notranslate nohighlight">\(t_n = t_0 + nh,\,t_0\)</span> being the initial time when <span class="math notranslate nohighlight">\(n = 0\)</span>, and the initial condition is <span class="math notranslate nohighlight">\(y(t_0)=y_0\)</span> .The times are <span class="math notranslate nohighlight">\(t_0,\,t_1 =t_0 +h,\,t_2 =t_0 +2h\)</span>, and so forth. The grey area in Fig 7 (left) is <span class="math notranslate nohighlight">\(hf(t_n, y_n)\)</span> which approximates the whole area under the curved line in the Euler method.</p>
<p>The calculation is easy to implement, but several terms have to be defined before starting. These are the initial condition, which means <span class="math notranslate nohighlight">\(t_0\)</span> and <span class="math notranslate nohighlight">\(y(t_0) = y_0\)</span>, the final time to stop the calculation <span class="math notranslate nohighlight">\(t_{max}\)</span>, and the number of points <span class="math notranslate nohighlight">\(N\)</span>. These will define <span class="math notranslate nohighlight">\(h\)</span> as <span class="math notranslate nohighlight">\(\displaystyle h= \frac{T_{max}-t_0}{N-1}\)</span>. Choosing <span class="math notranslate nohighlight">\(N\)</span> is not difficult; as a rule-of-thumb start with 100 points and see what happens, then repeatedly double or treble this value. Increasing <span class="math notranslate nohighlight">\(N\)</span> reduces <span class="math notranslate nohighlight">\(h\)</span> and this will often have to be <span class="math notranslate nohighlight">\(\ll\)</span> 0.01, but if it is too small, the calculation will take a considerable time to complete and therefore some compromise is always necessary.</p>
<p>Sometimes, the solution of the equation is sought to smaller values than <span class="math notranslate nohighlight">\(t_0\)</span>, effectively running the calculation backwards, which means making <span class="math notranslate nohighlight">\(h\)</span> negative. In this case, the time has to be reduced as <span class="math notranslate nohighlight">\(t_n=t_0-nh\)</span> and the consecutive values of y calculated as</p>
<div class="math notranslate nohighlight">
\[\displaystyle y_{n+1} = y_n - hf(t_n, y_n) \tag{20}\]</div>
<p><img alt="Drawing" src="_build_/jupyter_execute/chapter-11/num-methods-fig7.png" /></p>
<p>Fig. 7. The grey area is calculated in the Euler method (left) only very approximately measures the true area under the curve. On the right the improved Euler method is shown and is clearly better. The notation is <span class="math notranslate nohighlight">\(f_n \equiv f(t_n,y_n)\)</span>. The smaller <span class="math notranslate nohighlight">\(h\)</span> becomes the better the curve is approximated.</p>
</div>
<hr class="docutils" />
<div class="section" id="errors">
<h2>4. 2 Errors<a class="headerlink" href="#errors" title="Permalink to this headline">¶</a></h2>
<p>Before carrying out the calculation, the error implicit in this method should be considered. There will always be an error associated with a numerical method because an approximation to the derivative has always to be made. The error takes two forms; the approximation to <span class="math notranslate nohighlight">\(dy/dx\)</span> produces a truncation error; a better approximation could be made by expanding this as a series. The truncation errors can be <em>local</em> or <em>global</em>, the local error is that produced in a single step, the global is that accumulated after many steps. Generally, a smaller value of <span class="math notranslate nohighlight">\(h\)</span> reduces these errors; conversely, too large a value, which may not be realised beforehand, can lead to instability with the solution becoming erratic. Some small amount of experimenting is often required to fix <span class="math notranslate nohighlight">\(h\)</span> to an appropriate value. There are complex ways of estimating the errors but, pragmatically, it is simpler to double the number of points repeatedly until no change in the calculated data is observed.</p>
<p>The second form of error is due to rounding. A small value of <span class="math notranslate nohighlight">\(h\)</span> leads to many terms being summed, and depending on the particular form of <span class="math notranslate nohighlight">\(f(y, t)\)</span> this may or may not be important; only a calculation will reveal this. However, it can mostly be prevented by increasing the precision of the calculation. Most programmes nowadays use double precision floating point arithmetic, but if problems persist this may need to be increased.  How this is done is clearly specific to the language used.</p>
</div>
<div class="section" id="using-euler-s-method">
<h2>4.3 Using Euler’ s method<a class="headerlink" href="#using-euler-s-method" title="Permalink to this headline">¶</a></h2>
<p>To illustrate the method, the equation</p>
<div class="math notranslate nohighlight">
\[\displaystyle dy/dt = -2e^{3-t} - 3y\]</div>
<p>will be integrated from <span class="math notranslate nohighlight">\(t\)</span> = 2 to 7 with initial condition <span class="math notranslate nohighlight">\(y(t_0)\)</span> = 1, hence <span class="math notranslate nohighlight">\(t_0\)</span> = 2. This equation can be integrated analytically and this allows a check on the algorithm. The solution looks something like a Lennard - Jones  potential between two molecules or Morse potential between two atoms, with a single minimum and tending to infinity at <span class="math notranslate nohighlight">\(t\)</span> = 0 and to zero at large <span class="math notranslate nohighlight">\(t\)</span>.</p>
<p>The calculation starts by defining the initial values and other constants such as the number of points for the grid over which to do the calculation. Two arrays, Eulery and dtime, are used to store the results and the initial values are placed into the first element of each array. Notice that the values of <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(t\)</span> are both incremented in the for loop which changes <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(t\)</span> for each new step. The function to be integrated is always the right-hand side of the differential equation when written as <span class="math notranslate nohighlight">\(dy/dt = \cdots\)</span>. In the code the function, dydt, is passed into the subroutine Eulerf, which does the calculation, with the statement <span class="math notranslate nohighlight">\(\mathtt{soln0,time0 = Eulerf(dydt,t0,y0,maxt,N)}\)</span> which also returns the answers.</p>
<p>The outline algorithm 9 is</p>
<p><strong>(1)</strong><span class="math notranslate nohighlight">\(\quad\)</span> Define equation to integrate call this dydt .</p>
<p><strong>(2)</strong><span class="math notranslate nohighlight">\(\quad\)</span> Set initial parameters,<span class="math notranslate nohighlight">\(y_0,\,t_0\)</span>,number of integration points, <span class="math notranslate nohighlight">\(N\)</span></p>
<p><span class="math notranslate nohighlight">\(\quad\)</span> <strong>(i)</strong>  Calculate <span class="math notranslate nohighlight">\(h\)</span></p>
<p><span class="math notranslate nohighlight">\(\quad\)</span> <strong>(ii)</strong>  Save initial values</p>
<p><strong>(3)</strong><span class="math notranslate nohighlight">\(\quad\)</span> Start loop on <span class="math notranslate nohighlight">\(N\)</span></p>
<p><span class="math notranslate nohighlight">\(\quad\)</span> <strong>(i)</strong>  Increment <span class="math notranslate nohighlight">\(y\)</span> equation (11.19)</p>
<p><span class="math notranslate nohighlight">\(\quad\)</span> <strong>(ii)</strong> Increment <span class="math notranslate nohighlight">\(t\)</span></p>
<p><span class="math notranslate nohighlight">\(\quad\)</span> <strong>(iii)</strong> Save <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(t\)</span></p>
<p><span class="math notranslate nohighlight">\(\quad\)</span> <strong>(iv)</strong> end loop</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Algorithm 9: Euler&#39;s method</span>
<span class="c1">#--------------------------------</span>
<span class="k">def</span> <span class="nf">Eulerf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">maxt</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>            <span class="c1"># Euler method, function f </span>
    
    <span class="n">Eulery</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>    <span class="c1"># define arrays to hold results</span>
    <span class="n">dtime</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxt</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="n">N</span>
    <span class="c1">#print(&#39;step size&#39;,h)</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span>
    <span class="n">Eulery</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="n">y0</span>
    <span class="n">dtime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">t0</span>
    <span class="k">for</span>  <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>              <span class="c1"># loop starts</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>               <span class="c1"># increment y</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">h</span>                      <span class="c1"># time </span>
        <span class="n">Eulery</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>                  <span class="c1"># save values</span>
        <span class="n">dtime</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">t</span>
        <span class="k">pass</span>                           <span class="c1"># end of loop</span>
    <span class="k">return</span> <span class="n">Eulery</span><span class="p">,</span><span class="n">dtime</span>
<span class="c1">#---------------------------------</span>

<span class="n">dydt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span><span class="n">y</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">y</span>   <span class="c1"># equation to integrate </span>

<span class="n">t0</span>  <span class="o">=</span> <span class="mf">2.0</span>    <span class="c1"># initial values</span>
<span class="n">y0</span>  <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">maxt</span><span class="o">=</span> <span class="mf">7.0</span>
<span class="n">N</span>   <span class="o">=</span> <span class="mi">50</span>     <span class="c1"># number of points</span>

<span class="n">soln0</span><span class="p">,</span><span class="n">time0</span> <span class="o">=</span> <span class="n">Eulerf</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">maxt</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>  <span class="c1"># return results as arrays</span>

<span class="c1">#plt.plot(time0,soln0) # add plotting here</span>
<span class="c1">#plt.show()</span>
</pre></div>
</div>
</div>
</div>
<p>The numerical data stored as Eulery and dtime. Two results with the number of iterations as <span class="math notranslate nohighlight">\(N\)</span> = 50 and 500, and the analytic solution is plotted as shown in fig 8. With <span class="math notranslate nohighlight">\(N\)</span> = 500, only a slight difference between the analytic solution and numerical is observed and this becomes better if more points are used. The improved (modified) Euler method and the Runge - Kutta methods, see Section 7, produce curves essentially identical to the algebraic solution.</p>
<p><img alt="Drawing" src="_build_/jupyter_execute/chapter-11/num-methods-fig8.png" /></p>
<p>Figure 8 The algebraic solution to <span class="math notranslate nohighlight">\(dy/dt = -2e^{3-t} - 3y\)</span> (dotted line) and two Euler method numerical solutions with <span class="math notranslate nohighlight">\(N = 50\)</span> and <span class="math notranslate nohighlight">\(500\)</span>. The initial condition is <span class="math notranslate nohighlight">\(y(t_0) = 1\)</span> and <span class="math notranslate nohighlight">\(t_0 = 2\)</span>. The improved (modified) Euler method and the Runge - Kutta methods, Section 7, produce curves essentially identical to the algebraic solution.</p>
</div>
<hr class="docutils" />
<div class="section" id="improving-on-the-euler-method">
<h2>4.4 Improving on the Euler method<a class="headerlink" href="#improving-on-the-euler-method" title="Permalink to this headline">¶</a></h2>
<p>Many of the examples used are not particularly sensitive to the integration method; however, some equations are generally exquisitely sensitive, while others are only so for some sets of initial conditions and not for others. It is not obvious beforehand whether this is going to be the case or not and because of this more sophisticated integration schemes are necessary. The two described here are an improvement on the Euler algorithm and the Runge -Kutta method.</p>
<div class="section" id="modified-euler-or-heun-s-method">
<h3><strong>Modified Euler or Heun’s method</strong><a class="headerlink" href="#modified-euler-or-heun-s-method" title="Permalink to this headline">¶</a></h3>
<p>The Euler method is rather crude but is easy to implement and is easily improved. Consider again equation 19. The updated <span class="math notranslate nohighlight">\(y\)</span> value was calculated using</p>
<div class="math notranslate nohighlight">
\[\displaystyle y_{n+1} = y_n + hf(t_n,y_n)\]</div>
<p>but a better approximation to the area under the curve between <span class="math notranslate nohighlight">\(y_{n+1}\)</span> and <span class="math notranslate nohighlight">\(y_n\)</span> can be made than <span class="math notranslate nohighlight">\(hf(t_n, y_n)\)</span> which is a rectangle, Fig.7. This better approximation makes the area into a trapezoid and this is shown as shaded in the right-hand panel of Fig. 7. Its value is</p>
<div class="math notranslate nohighlight">
\[\displaystyle \frac{h}{2}\Big(f(t_n,y_n)+f(t_{n+1},y_{n+1})\Big)\]</div>
<p>The better method thus has an update term</p>
<div class="math notranslate nohighlight">
\[\displaystyle y_{n+1}=y_n+\frac{h}{2}\left[f(t_n,y_n)+f(t_{n+1},y_{n+1})\right]  \tag{21}\]</div>
<p>Some simplifications can now be made by replacing <span class="math notranslate nohighlight">\(t_{n+1} = t_n + h\)</span> and <span class="math notranslate nohighlight">\(y_{n+1} = y_n + hf(t_n, y_n)\)</span>, which is equation 19, into the second occurrence of the function to become the Modified Euler formula, which is sometimes also called Heun’s method. The result is</p>
<div class="math notranslate nohighlight">
\[\displaystyle y_{n+1}=y_n+\frac{h}{2}\left[f(t_n,y_n)+f(t_n+h,y_n+hf(t_n,y_n))\right]  \tag{22}\]</div>
<p>which contains a function within a function. This is more clearly written in three steps by defining new terms <span class="math notranslate nohighlight">\(k_1,k_2\)</span>;</p>
<div class="math notranslate nohighlight">
\[\displaystyle k_1 =f(t_n,y_n), \quad k_2 =f(t_n +h,y_n +hk_1),\quad  y_{n+1} =y_n +h(k_1 +k_2)/2 \tag{23}\]</div>
<p>This modification replaces the simpler expression in the  loop of the basic Euler code (Algorithm 9).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Algorithm 10: Modified Euler or Heun&#39;s method</span>
<span class="c1">#--------------------------</span>
<span class="k">def</span> <span class="nf">Mod_Eulerf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">maxt</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>            <span class="c1"># Euler method, function f </span>
    
    <span class="n">Eulery</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>    <span class="c1"># define arrays to hold results</span>
    <span class="n">dtime</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxt</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="n">N</span>
    <span class="c1">#print(&#39;step size&#39;,h) </span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span>
    <span class="n">Eulery</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="n">y0</span>
    <span class="n">dtime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">t0</span>
    <span class="k">for</span>  <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>              <span class="c1"># loop starts</span>
        <span class="n">k1</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>                    <span class="c1"># Changes start here</span>
        <span class="n">k2</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="o">*</span><span class="n">k1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="o">*</span><span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="n">k2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>          <span class="c1"># increment y</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">h</span>
        <span class="n">Eulery</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">dtime</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">pass</span>                           <span class="c1"># end of loop</span>
    <span class="k">return</span> <span class="n">Eulery</span><span class="p">,</span><span class="n">dtime</span>
<span class="c1">#--------------------------    </span>

<span class="n">dydt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span><span class="n">y</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">y</span>              <span class="c1"># equation to integrate </span>
<span class="n">t0</span>  <span class="o">=</span> <span class="mf">2.0</span>                              <span class="c1"># initial values</span>
<span class="n">y0</span>  <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">maxt</span><span class="o">=</span> <span class="mf">7.0</span>
<span class="n">N</span>   <span class="o">=</span> <span class="mi">50</span>                               <span class="c1"># number of points</span>
<span class="n">soln0</span><span class="p">,</span><span class="n">time0</span> <span class="o">=</span> <span class="n">Mod_Eulerf</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">maxt</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>         <span class="c1"># return results</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="runge-kutta-method">
<h3><strong>Runge - Kutta method</strong><a class="headerlink" href="#runge-kutta-method" title="Permalink to this headline">¶</a></h3>
<p>There are other more sophisticated methods than the modified Euler of which the Runge-Kutta method is often the method of choice. The Runge-Kutta method uses the average of the gradient at the mid- and end-points of an interval to calculate the next <span class="math notranslate nohighlight">\(y\)</span> value. This is an example of a <em>predictor - corrector</em> method, which as the name suggests, predicts the next value then makes a weighted correction to this (Prest et al. 1986). In this method, <em>four</em> quantities are required for each equation being solved. The equation being solved is as before <span class="math notranslate nohighlight">\(dy/dt = f(t, y)\)</span> and <span class="math notranslate nohighlight">\(h\)</span> is the increment in <span class="math notranslate nohighlight">\(t\)</span>.</p>
<div class="math notranslate nohighlight">
\[\begin{split}\displaystyle \begin{align}
k_1 =&amp;\; f(t_n,\; y_n)\\[0.15cm]
k_2 = &amp;\;f(t_n + h/2,\; y_n + k_1/2) \\[0.15cm]
k_3 =&amp;\;f(t_n +h/2,\;y_n +k_2/2)\\[0.15cm]
k_4 =&amp;\;f(t_n +h,\;y_n +k_3)\\[0.15cm]
y_{n+1} =&amp;\;y_n +h(k_1 +2k_2 +2k_3 +k_4)/6\\[0.15cm]
\end{align}\end{split}\]</div>
<p>Note that this method would be Simpson’s rule if <span class="math notranslate nohighlight">\(f (t, y)\)</span> did not depend on <span class="math notranslate nohighlight">\(y\)</span>. The modification to the Euler method inside the subroutine is shown below,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Algorithm 11: Runge - Kutta </span>
<span class="c1">#---------------------------------</span>
<span class="k">def</span> <span class="nf">Runge_Kutta</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">maxt</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>            <span class="c1"># Euler method, function f </span>
    
    <span class="n">Eulery</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>    <span class="c1"># define arrays to hold results</span>
    <span class="n">dtime</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxt</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="n">N</span>
    <span class="c1">#print(&#39;step size&#39;,h)</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span>
    <span class="n">Eulery</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="n">y0</span>
    <span class="n">dtime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">t0</span>
    <span class="k">for</span>  <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>              <span class="c1"># loop starts</span>
        <span class="n">k1</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        <span class="n">k2</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="o">*</span><span class="n">k1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">k3</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="o">*</span><span class="n">k2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">k4</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="o">*</span><span class="n">k3</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="o">*</span><span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">k2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">k3</span> <span class="o">+</span> <span class="n">k4</span><span class="p">)</span><span class="o">/</span><span class="mi">6</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">h</span>
        <span class="n">Eulery</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">dtime</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">pass</span>                           <span class="c1"># end of loop</span>
    <span class="k">return</span> <span class="n">Eulery</span><span class="p">,</span><span class="n">dtime</span>
<span class="c1">#-----------------------------------    </span>

<span class="n">dydt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span><span class="n">y</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">y</span>  <span class="c1"># equation to integrate </span>
<span class="n">t0</span>  <span class="o">=</span> <span class="mf">2.0</span>                               <span class="c1"># initial values</span>
<span class="n">y0</span>  <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">maxt</span><span class="o">=</span> <span class="mf">7.0</span>
<span class="n">N</span>   <span class="o">=</span> <span class="mi">50</span>                                <span class="c1"># number of points</span>
<span class="n">soln0</span><span class="p">,</span><span class="n">time0</span> <span class="o">=</span> <span class="n">Runge_Kutta</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">maxt</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>  <span class="c1"># return results</span>
</pre></div>
</div>
</div>
</div>
<p>You can use this method for any calculation for which the Euler or modified Euler method is appropriate; it will take slightly longer to calculate each step but should produce results that are more accurate with fewer data points. The method for coupled equations is described in Section 5. The relative errors in the Euler, modified Euler, and Runge - Kutta vary as <span class="math notranslate nohighlight">\(O(h^2),\; O(h^3)\)</span>  and <span class="math notranslate nohighlight">\( O(h^5)\)</span> respectively, where the local error is estimated as <span class="math notranslate nohighlight">\(| f(x) - f _{numeric}(x)|\)</span> with <span class="math notranslate nohighlight">\(f\)</span> as the true algebraic solution at some point <span class="math notranslate nohighlight">\(x\)</span>. Of course this error cannot generally be estimated.</p>
</div>
</div>
<div class="section" id="verlet-algorithm-calculating-dynamics-and-performing-md-simulations">
<h2>4.6 Verlet algorithm: calculating dynamics and performing MD simulations<a class="headerlink" href="#verlet-algorithm-calculating-dynamics-and-performing-md-simulations" title="Permalink to this headline">¶</a></h2>
<p>An MD simulation is a technique to calculate equilibrium and transport properties of many body systems, such as proteins, DNAs, polymers, or simple liquids. The calculation is normally classical, and integrates Newton’s equation of motion. As classical mechanics is used, quantum effects such as tunnelling are ignored. The speed and capacity of modern computers make MD a common tool for the study of bio-molecules in particular, and a vast literature exists.
The MD simulation proceeds by calculating the forces between pairs of particles and integrating them at some time t; this time is now incremented by a small amount <span class="math notranslate nohighlight">\(\Delta t\)</span> and the process repeated. In a protein or DNA, the forces between the atoms will comprise those of individual chemical bonds, with their own particular force constants for bond stretching, bending, and rotating. Between non-bonded atoms, Lennard-Jones type potentials could be used and the Coulomb potential between charged groups. These interactions can be- come rather complicated and are usually parameterized and standard sets of values used.</p>
<p>In the Verlet algorithm, the equations of motion are not solved as such, which means that the starting point is not to simplify the differential equation and then approximate them as done in the Euler and Runge - Kutta methods. Instead, a Taylor expansion in time about the initial position is made. To use the Verlet algorithm, the force or acceleration of each particle must be known; this is always the case once the potential is known because force is the negative derivative of the potential with distance; <span class="math notranslate nohighlight">\(f_x = -dU(x)/dx\)</span>. As the equations of motion are second order, two initial conditions are necessary for each atom or molecule and these are the starting point and the initial velocity. From these, the next position, a very small distance away, is calculated, perhaps by using Newton’s laws, and from these two positions all the other positions, and the corresponding velocities, can be found from the algorithm.</p>
<p>The Verlet calculation starts by making a Taylor expansion (see Chapter 5) about the position at time <span class="math notranslate nohighlight">\(t + \Delta t\)</span> and <span class="math notranslate nohighlight">\(t - \Delta t\)</span> and the sum and difference between these two positions calculated. The formula for a Taylor series of any function <span class="math notranslate nohighlight">\(f(x)\)</span> expanded about a point <span class="math notranslate nohighlight">\(x_0\)</span>, is</p>
<div class="math notranslate nohighlight">
\[\displaystyle f(x)=f(x_0)+(x-x_0)\left( \frac{df}{dx} \right)_{x_0}+\frac{(x-x_0)^2}{2!}\left( \frac{d^2f}{dx^2} \right)_{x_0} +\cdots \]</div>
<p>Changing notation, from the general to the specific, the function <span class="math notranslate nohighlight">\(f\)</span> represents position <span class="math notranslate nohighlight">\(r\)</span> which is a function of time; the notational change is <span class="math notranslate nohighlight">\(f (x) \to r(t)\)</span>. Expanding <span class="math notranslate nohighlight">\(r\)</span> about time <span class="math notranslate nohighlight">\(t_0\)</span> to <span class="math notranslate nohighlight">\(t = t_0 + \Delta t\)</span>, where <span class="math notranslate nohighlight">\(\Delta t\)</span> is a small time step,  gives</p>
<div class="math notranslate nohighlight">
\[\displaystyle r(t_0+\Delta t)=r(t_0)+v(t_0)\Delta t+\frac{(\Delta t)^2}{2!}\left( \frac{d^2r}{dt^2} \right)_{t_0} +\frac{(\Delta t)^3}{3!}\left( \frac{d^3r}{dt^3} \right)_{t_0} +\cdots \]</div>
<p>Similarly for a small decrease in time</p>
<div class="math notranslate nohighlight">
\[\displaystyle r(t_0-\Delta t)=r(t_0)-v(t_0)\Delta t+\frac{(\Delta t)^2}{2!}\left( \frac{d^2r}{dt^2} \right)_{t_0} -\frac{(\Delta t)^3}{3!}\left( \frac{d^3r}{dt^3} \right)_{t_0} +\cdots \]</div>
<p>where the velocity <span class="math notranslate nohighlight">\(v(t_0)=(dx/dt)_{t_0}\)</span>. The acceleration is <span class="math notranslate nohighlight">\((d^2r/dt^2)_{t_0}=f(t_{t_0})/m\)</span> where <span class="math notranslate nohighlight">\(m\)</span> is the mass and <span class="math notranslate nohighlight">\(f\)</span> is the force, which is calculated from the potential at the position corresponding to time <span class="math notranslate nohighlight">\(t_0\)</span>. The sum and the difference of increments in <span class="math notranslate nohighlight">\(r\)</span> are</p>
<div class="math notranslate nohighlight">
\[\displaystyle  r(t_0+\Delta t)+r(t_0-\Delta t)=2r(t_0)+(\Delta t)^2\left( \frac{d^2r}{dt^2} \right)_{t_0}+\cdots \tag{24}\]</div>
<div class="math notranslate nohighlight">
\[\displaystyle  r(t_0+\Delta t)-r(t_0-\Delta t)=2\Delta t r(t_0)+2\frac{(\Delta t)^3}{3!}\left( \frac{d^3r}{dt^3} \right)_{t_0} +\cdots \tag{25}\]</div>
<p>If the time increment <span class="math notranslate nohighlight">\(\Delta t\)</span> is small, the third and higher derivatives can be ignored giving from equation 24</p>
<div class="math notranslate nohighlight">
\[\displaystyle  r(t_0+\Delta t)\approx 2r(t_0)-r(t_0-\Delta t)+\frac{f(t_0)}{m}(\Delta t)^2  \tag{26}\]</div>
<p>which will be the new position of the particle after time step <span class="math notranslate nohighlight">\(\Delta t\)</span>. The velocity is obtained from equation 25 as the difference</p>
<div class="math notranslate nohighlight">
\[\displaystyle v(t_0)\approx \frac{r(t_0+\Delta t)-r(t_0-\Delta t)}{2\Delta t}  \tag{27}\]</div>
<p>and not directly. These two equations give the new position and velocity and form the basis of the Verlet algorithm.</p>
<p>To begin the calculation, two positions have to be known; equation 26 indicates that <span class="math notranslate nohighlight">\(r\)</span> is needed at times <span class="math notranslate nohighlight">\(t_0\)</span> and <span class="math notranslate nohighlight">\(t_0 - \Delta t\)</span>. If <span class="math notranslate nohighlight">\(\Delta t\)</span> is small, the latter can be approximated as <span class="math notranslate nohighlight">\(r(t_0) - v_0\Delta t\)</span> with initial velocity <span class="math notranslate nohighlight">\(v_0\)</span>. It seems strange to have to calculate values before the initial time, which could be negative, but this is what is required.</p>
<p>The next step of the algorithm updates positions and forces and increments the time. The positions at the old time <span class="math notranslate nohighlight">\(t_0 - \Delta t\)</span> can be discarded; the current positions become the old ones and the new positions become the current ones. The force is also re-evaluated at the new position. This process is repeated in a loop with as many steps as are required. The forces are initially calculated outside the loop, and are calculated again at the end of the loop and are therefore ready to use when the loop restarts.</p>
<p>The elementary Verlet algorithm has the form:</p>
<p><strong>(1)</strong><span class="math notranslate nohighlight">\(\quad\)</span> Define potential energy or force &amp; number of time steps.</p>
<p><strong>(2)</strong><span class="math notranslate nohighlight">\(\quad\)</span> Define initial position <span class="math notranslate nohighlight">\(r(t_0)\)</span>, velocity <span class="math notranslate nohighlight">\(v\)</span>, and force.</p>
<p><span class="math notranslate nohighlight">\(\qquad\)</span> Calculate second position at <span class="math notranslate nohighlight">\(t_0 - \Delta t\)</span>.</p>
<p><strong>(3)</strong><span class="math notranslate nohighlight">\(\quad\)</span> Loop over time steps</p>
<p><span class="math notranslate nohighlight">\(\quad\)</span><strong>(i)</strong> Calculate new positions and velocities if needed.</p>
<p><span class="math notranslate nohighlight">\(\quad\)</span><strong>(ii)</strong>  Calculate and save quantities to be measured; energy, distance,etc.</p>
<p><span class="math notranslate nohighlight">\(\quad\)</span><strong>(ii)</strong>  Increment time.</p>
<p><span class="math notranslate nohighlight">\(\quad\)</span><strong>(iv)</strong>  Recalculate forces.</p>
<p><span class="math notranslate nohighlight">\(\quad\)</span><strong>(v)</strong> end loop.</p>
<p>Continue until total time is reached.</p>
<p>Before an example is worked through, a couple of topics need a brief mention.</p>
</div>
<div class="section" id="molecular-dynamics-simulations">
<h2>4.7 Molecular dynamics simulations<a class="headerlink" href="#molecular-dynamics-simulations" title="Permalink to this headline">¶</a></h2>
<p>The Verlet is widely used in MD simulations because it is time symmetric and so conserves energy well. As it is less complicated, it works faster than other integration schemes. In an MD simulation, time steps are typically <span class="math notranslate nohighlight">\(10^{-15}\)</span> s, when put into real units, because chemical bond vibrational periods are <span class="math notranslate nohighlight">\(\approx 10^{-14}\)</span> s and several samples will be needed in each period. As with any numerical integration, the time step has to be short enough to allow an accurate calculation, but not so short that the calculation becomes unnecessarily long. The implementation of MD schemes is too long to discuss here; obviously many hundreds of atoms are present, the velocity and position of each has to be calculated in turn, subject to the interaction potential a molecules has with each of its neighbours. The way that coupled equations are dealt with is described in Section 5, the MD calculation takes this to extreme with thousands of equations but the basic idea is the same. Frenkel &amp; Smit (1996) give basic algorithms, and detailed ones can be found in Allen &amp; Tilldesley (1987).</p>
</div>
<div class="section" id="other-verlet-algorithms">
<h2>4.8 Other Verlet algorithms<a class="headerlink" href="#other-verlet-algorithms" title="Permalink to this headline">¶</a></h2>
<p>There are other widely used versions of this algorithm, examples are the velocity Verlet and the Beeman algorithm, both of which give a better estimation of the velocities (see Frenkel &amp; Smit 1996). This is because there is no subtraction of two large numbers as in equation 27, which is the main disadvantage of the basic Verlet algorithm.</p>
<p>The equations for the velocity Verlet method can be shown to be the same as for the normal Verlet. The position and velocity equations are</p>
<div class="math notranslate nohighlight">
\[\displaystyle  r(t_0+\Delta t)= r(t_0)+v(t_0)\Delta t+\frac{f(t_0)}{m}(\Delta t)^2  \tag{28}\]</div>
<div class="math notranslate nohighlight">
\[\displaystyle v(t_0+\Delta t)= v(t_0)+\frac{f(t_0)+f(t_0+\Delta t)}{2m}  \]</div>
<p>and because the force is needed in the velocity equation at <span class="math notranslate nohighlight">\(t_0+\Delta t\)</span>, the calculation has to be done in two steps. The position is calculated using 28, then the velocity at half a step calculated using</p>
<div class="math notranslate nohighlight">
\[\displaystyle v(t_0 + \Delta t/2) = v(t_0) + f (t_0)/2m \tag{29}\]</div>
<p>and the force is calculated at <span class="math notranslate nohighlight">\(t_0 + \Delta t\)</span>, using the position <span class="math notranslate nohighlight">\(r(t_0 + \Delta t)\)</span>, and the velocity finally obtained is</p>
<div class="math notranslate nohighlight">
\[\displaystyle v(t_0 + \Delta t) = v(t_0 + \Delta t/2) + f (t_0 + \Delta t)/2m \tag{30}\]</div>
</div>
<div class="section" id="basic-verlet-algorithm">
<h2>4.9 Basic Verlet Algorithm<a class="headerlink" href="#basic-verlet-algorithm" title="Permalink to this headline">¶</a></h2>
<p>Consider calculating the position and velocity of a ball dropped from a height of <span class="math notranslate nohighlight">\(h = 30\)</span> metres until it reaches the ground. The equation of motion is obtained by balancing forces and is <span class="math notranslate nohighlight">\(md^2y/dt^2 + mg = 0\)</span> where <span class="math notranslate nohighlight">\(m\)</span> is the mass of the ball, which cancels out, and <span class="math notranslate nohighlight">\(g\)</span> the acceleration due to gravity <span class="math notranslate nohighlight">\(9.81\,\mathrm{ ms^{-2}}\)</span>. The time steps have to be determined by trial and error but the calculation is quite accurate with time steps of <span class="math notranslate nohighlight">\(0.005\)</span> s.</p>
<p>To start the calculation, two positions are needed. If the initial position is <span class="math notranslate nohighlight">\(y_0\)</span> and velocity <span class="math notranslate nohighlight">\(v_0\)</span>, the other can be calculated from Newton’s laws using <span class="math notranslate nohighlight">\(v_{old} = v_0 + (-g)(-\Delta t)\)</span> and <span class="math notranslate nohighlight">\(y_{old} = y_0 - v_{old}\Delta t\)</span>. The acceleration is constant at all times and is <span class="math notranslate nohighlight">\(-g\)</span>. The Verlet algorithm is as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Algorithm 12; Verlet method. Falling under gravity</span>

<span class="n">y0</span> <span class="o">=</span> <span class="mf">30.0</span>     <span class="c1"># initial height  metres</span>
<span class="n">v0</span> <span class="o">=</span> <span class="mf">0.0</span>      <span class="c1"># initial velocity  m/s</span>
<span class="n">t</span>  <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.005</span>    <span class="c1"># timer increment  seconds</span>
<span class="n">g</span>  <span class="o">=</span> <span class="mf">9.8</span>      <span class="c1"># acceleration m/s/s</span>
<span class="n">n</span>  <span class="o">=</span> <span class="mi">2000</span>     <span class="c1"># number of data points</span>

<span class="n">height</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>     <span class="c1"># define arrays to hold data</span>
<span class="n">atime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">velo</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="n">height</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="n">y0</span>    <span class="c1"># set initial point </span>
<span class="n">atime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
<span class="n">velo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">v0</span>
<span class="n">accln</span>    <span class="o">=</span> <span class="o">-</span><span class="n">g</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">y0</span>
<span class="n">yold</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">v0</span><span class="o">*</span><span class="n">dt</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>                 <span class="c1"># Verlet loop  </span>
    <span class="n">ynew</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">y</span> <span class="o">-</span> <span class="n">yold</span> <span class="o">+</span> <span class="n">accln</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># eqn 26 with f(t0) included</span>
    <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">ynew</span> <span class="o">-</span> <span class="n">yold</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span>         <span class="c1"># eqn 27</span>
    <span class="n">yold</span> <span class="o">=</span> <span class="n">y</span>
    <span class="n">y</span>    <span class="o">=</span> <span class="n">ynew</span>
    <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="p">:</span>                    <span class="c1"># ball stots on ground</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">v</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">pass</span>
    <span class="n">height</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="n">ynew</span>                  <span class="c1"># store new values</span>
    <span class="n">velo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">v</span>
    <span class="n">atime</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<p>The calculation fixes the velocity and position (<span class="math notranslate nohighlight">\(y\)</span>) at zero when the ball hits the ground and for all the remaining time i.e. bouncing is not considered but is in question 11. The calculation is quite accurate with the small time step used, but more accurate if this is made smaller. Note that a check is made to prevent <span class="math notranslate nohighlight">\(y\)</span> becoming negative because the ball cannot go into the ground. The rate of change of velocity with time, the acceleration, is constant as expected, because the force of gravity is constant.</p>
<p><img alt="Drawing" src="_build_/jupyter_execute/chapter-11/num-methods-fig9.png" /></p>
<p>Fig. 9 Verlet calculation showing height and velocity vs time for a ball dropped under gravity. The velocity instantaneously becomes zero and remains so as the ball hits the ground.</p>
</div>
<hr class="docutils" />
<div class="section" id="the-verlet-algorithm-used-to-calculate-atom-scattering-trajectories">
<h2>4.10 The Verlet algorithm used to calculate atom scattering trajectories<a class="headerlink" href="#the-verlet-algorithm-used-to-calculate-atom-scattering-trajectories" title="Permalink to this headline">¶</a></h2>
<p>The trajectory, followed by the scattering by one particle off another, described in Section 3.6, will be calculated with a Lennard-Jones 6-12 (LJ6-12) potential. Fig. 4 shows the geometry, and the accompanying text describes the background to this problem. The LJ potential has a wide but shallow attractive well and a narrow and very steep repulsive wall at short range; its equation is</p>
<div class="math notranslate nohighlight">
\[U(r) = 4\epsilon[(\sigma/r)^{12}- (\sigma/r)^6]\]</div>
<p>and for simplicity <span class="math notranslate nohighlight">\(\epsilon = \sigma = 1\)</span> is used. The initial energy of the incoming particle is <span class="math notranslate nohighlight">\(E = 1/5\)</span>. The reduced mass of the particles is assumed to be <span class="math notranslate nohighlight">\(1\)</span>. The impact parameter <span class="math notranslate nohighlight">\(b\)</span>, is in the y-direction; the starting <span class="math notranslate nohighlight">\(x\)</span> value is <span class="math notranslate nohighlight">\(x_0 = -10\)</span>, which is sufficiently far away to only weakly feel the potential. The particle initially approaches parallel to the x-axis; the initial velocity in the x-direction is <span class="math notranslate nohighlight">\(v_x\)</span> (see Algorithm 13) and the velocity in the y direction is zero. This initial distance <span class="math notranslate nohighlight">\(y_0\)</span>, is the impact parameter <span class="math notranslate nohighlight">\(b\)</span>. The potential <span class="math notranslate nohighlight">\(U\)</span> and force <span class="math notranslate nohighlight">\(-dU(r)/dr\)</span>, is calculated from the radial distance <span class="math notranslate nohighlight">\(r\)</span> between the two particles. However, our calculation uses <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> coordinates not <span class="math notranslate nohighlight">\(r\)</span>. The radial distance is related to x and y via <span class="math notranslate nohighlight">\(r = x^2 + y^2\)</span>. The algorithm also requires the forces along x and y and these components are calculated as</p>
<div class="math notranslate nohighlight">
\[\displaystyle -\frac{dU(r)}{dx} =-\left( \frac{dU(r)}{dr} \right)\left(\frac{dr}{dx} \right) \]</div>
<p>and similarly, for <span class="math notranslate nohighlight">\(y\)</span>. Unsurprisingly, these forces are called <span class="math notranslate nohighlight">\(fx\)</span> and <span class="math notranslate nohighlight">\(fy\)</span> in the calculation. The time step is <span class="math notranslate nohighlight">\(0.02\)</span> and <span class="math notranslate nohighlight">\(2000\)</span> steps are taken in total. The initial radial velocity is calculated from the energy as <span class="math notranslate nohighlight">\(v_r = \sqrt{2E_0}\)</span>, as we are assuming the reduced mass is unity.</p>
<p>To start the calculation, the position at two times <span class="math notranslate nohighlight">\(t_0\)</span> and <span class="math notranslate nohighlight">\(t_0 - \Delta t\)</span> has to be known, see (Equation 26). The coordinate at <span class="math notranslate nohighlight">\(t_0\)</span> is at <span class="math notranslate nohighlight">\((x_0, y_0)\)</span> and that at <span class="math notranslate nohighlight">\(t_0 - \Delta t\)</span> has to be found. This is crucial because the velocity of the particle is not used elsewhere in this calculation. If this is not approximated accurately, the consequence is that a different initial energy rather than <span class="math notranslate nohighlight">\(E_0\)</span> will have been used. The calculation is started at a large negative <span class="math notranslate nohighlight">\(x\)</span> value, where the particle is approaching almost parallel to the x-axis at a height <span class="math notranslate nohighlight">\(y_0\)</span>. The positions at <span class="math notranslate nohighlight">\(t_0 - \Delta t\)</span> can be approximated by taking fractions of the velocity in the <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> directions to give <span class="math notranslate nohighlight">\((x_0 + v_r\Delta tx_0/r, y_0 - v_r \Delta ty_0/r)\)</span>.</p>
<p>Although these work reasonably well, they are not quite accurate enough as they give the approaching particle too much energy. This can be observed by calculating the minimum approach distance <span class="math notranslate nohighlight">\(r_0\)</span> and comparing that with a trajectory. It is found that, given its initial energy, the particle passes closer to the target particle than it should; it crosses the boundary defined by a circle of radius <span class="math notranslate nohighlight">\(r_0\)</span>, which is given by equation 15. A better approximation is to use equation 7 to calculate <span class="math notranslate nohighlight">\(v\)</span>. This gives the particle at
<span class="math notranslate nohighlight">\(t_0 - \Delta t\)</span> the coordinates</p>
<div class="math notranslate nohighlight">
\[\displaystyle x_0-\frac{x_0\Delta t}{r}\sqrt{2}\sqrt{E_0-E_0\left(\frac{y_0}{2}\right)^2-U(r)},\quad  y_0  \tag{31}\]</div>
<p>where only the <span class="math notranslate nohighlight">\(x\)</span> value is changed because equation 7 assumes that the particle is parallel to the x-axis. This gives the trajectory a good approximation to <span class="math notranslate nohighlight">\(r_0\)</span>, the distance of closest approach.</p>
<p>The initial velocity only is used in the initial step; the velocity of the particle is not needed elsewhere in this particular calculation but if needed then equation 27 can be used to find <span class="math notranslate nohighlight">\(v_x\)</span> and <span class="math notranslate nohighlight">\(v_y\)</span>. The radial velocity <span class="math notranslate nohighlight">\(v_r\)</span> at any given time, at point <span class="math notranslate nohighlight">\((x, y)\)</span>, is the sum of the <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> components calculated as</p>
<div class="math notranslate nohighlight">
\[\displaystyle  v_r=\frac{dr}{dx}\frac{dx}{dt}+\frac{dr}{dy}\frac{dy}{dt}=\frac{x}{r}v_x+\frac{y}{r}v_y   \]</div>
<p>The radial velocity <span class="math notranslate nohighlight">\(v_r\)</span> is zero when the two particles are at their closest point although the individual components may not be zero.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Algorithm 13; Atom atom scattering using the Verlet method</span>
<span class="c1"># the plotting is commented out</span>
<span class="c1">#-------------------------------</span>
<span class="k">def</span> <span class="nf">scattering</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>        <span class="c1"># uses Verlet  algorithm</span>

    <span class="n">atime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">posx</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">posy</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="n">posx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="n">posy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y0</span>
    <span class="n">atime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x0</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">y0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span>
    
    <span class="n">fx</span> <span class="o">=</span> <span class="n">ff</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">r</span>    <span class="c1"># components</span>
    <span class="n">fy</span> <span class="o">=</span> <span class="n">ff</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="n">r</span>
    
    <span class="n">xold</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="mi">2</span><span class="o">*</span><span class="n">E0</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">E0</span><span class="o">*</span><span class="p">(</span><span class="n">y0</span><span class="o">/</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">r</span>  <span class="c1"># eq 31 get starting coords</span>
    <span class="n">yold</span> <span class="o">=</span> <span class="n">y0</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>                <span class="c1"># Verlet </span>
        <span class="n">xnew</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">xold</span> <span class="o">+</span> <span class="n">fx</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span>    <span class="c1"># eqn 26 for x and y</span>
        <span class="n">ynew</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">y</span> <span class="o">-</span> <span class="n">yold</span> <span class="o">+</span> <span class="n">fy</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">xold</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">yold</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">x</span>    <span class="o">=</span> <span class="n">xnew</span>
        <span class="n">y</span>    <span class="o">=</span> <span class="n">ynew</span>
        <span class="n">posx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="n">x</span>                 <span class="c1"># save values</span>
        <span class="n">posy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="n">y</span>
        <span class="n">atime</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">t</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span>                 <span class="c1"># increment time </span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">fx</span><span class="o">=</span> <span class="n">ff</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">r</span>
        <span class="n">fy</span><span class="o">=</span> <span class="n">ff</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="n">r</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">posx</span><span class="p">,</span><span class="n">posy</span>
<span class="c1">#---------------------------------</span>

<span class="n">U</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">eps</span><span class="o">/</span><span class="mf">4.0</span><span class="o">*</span><span class="p">(</span> <span class="p">(</span><span class="n">sig</span><span class="o">/</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mi">12</span> <span class="o">-</span> <span class="p">(</span><span class="n">sig</span><span class="o">/</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mi">6</span> <span class="p">)</span>         <span class="c1"># define LJ potential</span>
<span class="n">ff</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="mi">24</span><span class="o">*</span><span class="n">eps</span><span class="o">/</span><span class="n">sig</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">sig</span><span class="o">/</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mi">13</span> <span class="o">-</span> <span class="p">(</span><span class="n">sig</span><span class="o">/</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mi">7</span><span class="p">)</span>      <span class="c1"># LJ force</span>

<span class="n">eps</span> <span class="o">=</span> <span class="mf">1.0</span>      <span class="c1"># set initial values</span>
<span class="n">sig</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">E0</span>  <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">n</span>   <span class="o">=</span> <span class="mi">2000</span>
<span class="n">x0</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">10.0</span>
<span class="n">y0</span>  <span class="o">=</span> <span class="mf">2.28</span>      <span class="c1"># impact parameter b</span>
<span class="n">t</span>   <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">dt</span>  <span class="o">=</span> <span class="mf">0.02</span>      <span class="c1"># time step</span>

<span class="c1">#fig1 = plt.figure(figsize=(9,8))</span>
<span class="c1">#plt.axes().set_aspect(1)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">y0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">j</span><span class="o">*</span><span class="mf">0.15</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">21</span><span class="p">)]):</span>   <span class="c1"># calculate range of values</span>
    <span class="n">posx</span><span class="p">,</span> <span class="n">posy</span> <span class="o">=</span> <span class="n">scattering</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">ff</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span>            <span class="c1"># pass potential, force and other params into calc.</span>
    
    <span class="c1">#plt.plot(posx,posy,linewidth=2,color = plt.cm.brg_r(15*i))</span>
</pre></div>
</div>
</div>
</div>
<p><img alt="Drawing" src="_build_/jupyter_execute/chapter-11/num-methods-fig10.png" /></p>
<p>Figure 10. Trajectories calculated with a Lennard-Jones potential (<span class="math notranslate nohighlight">\(\epsilon = \sigma = 1\)</span>) with an initial energy of <span class="math notranslate nohighlight">\(E = 1/5\)</span>. The impact parameter <span class="math notranslate nohighlight">\(b\)</span> starts at zero and is incremented by <span class="math notranslate nohighlight">\(0.15\)</span> in the y-direction. The inner grey circle is the potential at energy <span class="math notranslate nohighlight">\(E\)</span>, the outer and wide grey circle is the potential minimum and the middle circle has a radius <span class="math notranslate nohighlight">\(0.99\)</span>, which is a typical value for <span class="math notranslate nohighlight">\(r_0\)</span>. The centre of the circle is at coordinate (<span class="math notranslate nohighlight">\(0, 0\)</span>). The value at <span class="math notranslate nohighlight">\(b = 1.65\)</span> is a Glory scattering as the overall beam is undeflected.</p>
<hr class="docutils" />
<p>Several trajectories, <span class="math notranslate nohighlight">\(x\)</span> vs <span class="math notranslate nohighlight">\(y\)</span>, are plotted in Fig. 10 with increasing impact parameter <span class="math notranslate nohighlight">\(b\)</span> starting at zero. Plotting the final angles <span class="math notranslate nohighlight">\(\chi\)</span> relative to the horizontal, except that at <span class="math notranslate nohighlight">\(b \approx 2.29\)</span>, produces a curve similar to that shown in Fig. 6 for the same initial energy. The inner grey circle is the potential at <span class="math notranslate nohighlight">\(E = 1/5\)</span>, and the wide grey line follows the bottom of the potential well. The middle circle is the average value of <span class="math notranslate nohighlight">\(r_0\)</span>, which <span class="math notranslate nohighlight">\(\approx 0.99\)</span> because the repulsive potential is so steep.</p>
<p>The effect that the attractive and repulsive parts of the potential have is clear. At small impact parameter, the repulsive part of the potential acts not unlike a hard sphere and the approaching particle bounces almost straight off. As the impact parameter is increased, more of the attractive and less of the repulsive part of the potential is felt. Eventually the attractive potential only gradually draws the particle in only to force it to be violently repelled at a smaller separation. Then at an impact of about <span class="math notranslate nohighlight">\(2.27 \to 2.295\)</span> the attraction almost exactly balances the kinetic energy and the incoming particle is trapped for a short period and performs a complete orbit or two before leaving. At still greater impact para- meter, all that the potential can now do is to bend the incoming particle from its initial course. The trajectory at <span class="math notranslate nohighlight">\(b = 1.65\)</span> has almost zero displacement and is called a ‘Glory’, see also Fig. 6 which shows the scattering angle <span class="math notranslate nohighlight">\(\chi\)</span> vs impact parameter.</p>
</div>
<div class="section" id="a-numerical-solution-of-the-diffusion-equation-illustrated-with-transient-grating-decay">
<h2>4.10a  Numerical solution of the Diffusion equation illustrated with transient grating decay.<a class="headerlink" href="#a-numerical-solution-of-the-diffusion-equation-illustrated-with-transient-grating-decay" title="Permalink to this headline">¶</a></h2>
<p>Although the diffusion equation can be solved in many simple cases, often the geometry needed for a particular experiment is not simple and then a numerical solution is the only course of action. This is particularly the case for two and three dimensional problems.</p>
<p>Often reaction and diffusion may be taking place and then the diffusion equation is extended with a rate expression and becomes</p>
<div class="math notranslate nohighlight">
\[\displaystyle \frac{dC}{dt}=D\frac{d^2C}{dx^2}+ \text{rate expression} \tag{31a}\]</div>
<p>where <span class="math notranslate nohighlight">\(C\)</span> is the concentration of some species and <span class="math notranslate nohighlight">\(D\)</span> the diffusion constant. The rate expression has the form <span class="math notranslate nohighlight">\(k[C][\cdots]\)</span> where <span class="math notranslate nohighlight">\(k\)</span> is a rate constant multiplied, as appropriate for the chemistry, by concentrations. In heat flow problems the concentration is replaced by temperature and the diffusion coefficient by thermal diffusivity, both have dimensions of length<span class="math notranslate nohighlight">\(^2\)</span>/time. Initially we shall ignore the rate expression term and deal with a single diffusing species in one dimension but suppose that the initial concentration has an interesting spatial profile.</p>
<p>To tackle the calculation suppose that there is a grid of points in <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(t\)</span> over which the calculation is being performed, see figure 10a. The derivatives are calculated as differences by assuming small increments in <span class="math notranslate nohighlight">\(t\)</span> and <span class="math notranslate nohighlight">\(x\)</span>. The values are <span class="math notranslate nohighlight">\(\Delta x = 1/(m-1)\)</span> for a grid of <span class="math notranslate nohighlight">\(i=0\cdots m \)</span> points and similarly for time <span class="math notranslate nohighlight">\(\Delta t = 1/(n-1)\)</span> with <span class="math notranslate nohighlight">\(j= 0\cdots  n\)</span> points. The total length is <span class="math notranslate nohighlight">\(L = m\Delta x\)</span>, and total time <span class="math notranslate nohighlight">\(T_{max} = n\Delta t\)</span>. The approximation to the first derivatives are simple differences which approximate the true derivative when these differences are exceedingly small</p>
<div class="math notranslate nohighlight">
\[\displaystyle \frac{dC}{dt}\approx \frac{C_i^{j+1}-C_i^j }{\Delta t} \]</div>
<div class="math notranslate nohighlight">
\[\displaystyle \frac{dC}{dx}\approx \frac{C_{i+1}^{j}-C_i^j}{\Delta x} \]</div>
<p>where subscript <span class="math notranslate nohighlight">\(i\)</span> is a spatial index with step <span class="math notranslate nohighlight">\(\Delta x\)</span> and superscript <span class="math notranslate nohighlight">\(j\)</span> a time position index with step <span class="math notranslate nohighlight">\(\Delta t\)</span>. This arrangement is equivalent to the Euler approximation which is the simplest of various such schemes. Other more sophisticated schemes are Heun’s method (a modification of Euler) and  Runge-Kutta, see section 4.</p>
<p>The second derivative  is calculated as two further terms and the approximation to the diffusion equation becomes</p>
<div class="math notranslate nohighlight">
\[\displaystyle \frac{C_i^{j+1}-C_i^j}{\Delta t}=\frac{D}{\Delta x}\left(\frac{C_{i+1}^j-C_i^j}{\Delta x}-\frac{C_i^j-C_i^{j-1}}{\Delta x} \right)\]</div>
<p>This can be rearranged into a new form</p>
<div class="math notranslate nohighlight">
\[\displaystyle C_i^{new} = C_i^{old} + \frac{D\Delta t}{(\Delta x)^2}\left(  C_{i+1}^{old}-2C_i^{old} +C_{i-1}^{old}  \right) \tag{31b} \]</div>
<p>where <span class="math notranslate nohighlight">\(new=j+1\)</span> and <span class="math notranslate nohighlight">\(old=j\)</span> so that each new concentration term requires 3 older terms at different spatial positions. This type of approach is called a Fully Implicit Method. The stencil shows the points used in the calculation, fig 10a.</p>
<p><img alt="Drawing" src="_build_/jupyter_execute/chapter-11/num-methods-fig10a.png" /></p>
<p>Figure 10 a. The Stencil used to calculate the updating points.</p>
<hr class="docutils" />
<p>The condition for absolute stability depends on both the spatial and temporal steps and is <span class="math notranslate nohighlight">\(\displaystyle \frac{D\Delta t}{(\Delta x)^2} \le 1/2\)</span> and  making <span class="math notranslate nohighlight">\(m\)</span> bigger (more spatial grid points) is the only way to ensure absolute stability since the spatial extent is defined in the initial conditions pertaining to the problem at hand and <span class="math notranslate nohighlight">\(\Delta t\)</span>c depend on <span class="math notranslate nohighlight">\(\delta x\)</span>.</p>
<div class="section" id="initial-conditions">
<h3><strong>Initial Conditions</strong><a class="headerlink" href="#initial-conditions" title="Permalink to this headline">¶</a></h3>
<p>As with the solution of any differential equation  the calculation cannot be completed until the initial conditions have been specified. There are two types of these. The simplest to apply is to fix the value of <span class="math notranslate nohighlight">\(C\)</span> at the edge of the grid to a constant value, the Dirichlet condition, the other is to make the gradient at the edge a constant value, Neumann condition. The former is more suitable for thermal calculations where the edges can be kept at a constant temperature. It would be hard to make a membrane that held the same chemical species at a higher concentration on one side than the other.</p>
<p>The  Neumann initial condition is</p>
<div class="math notranslate nohighlight">
\[\displaystyle \frac{dC}{dx}=\alpha\quad \text{at}\quad x = 0\]</div>
<div class="math notranslate nohighlight">
\[\displaystyle \frac{dC}{dx}=\beta\quad\text{at}\quad x= L\]</div>
<p>where <span class="math notranslate nohighlight">\(\alpha,\;\beta\)</span> are constants. This condition ensures conservation of mass as no material can enter or leave and is enabled by making <span class="math notranslate nohighlight">\(C_0= C_1, C_m = C_{m-1}\)</span> at each updating step.  The same condition when dealing with thermal diffusion corresponds to having an insulated block of material unable to exchange energy with its surroundings.</p>
</div>
<div class="section" id="example-calculation-decay-of-transient-grating-see-also-chapter-10-10">
<h3><strong>Example Calculation: Decay of Transient Grating. (See also chapter 10.10.)</strong><a class="headerlink" href="#example-calculation-decay-of-transient-grating-see-also-chapter-10-10" title="Permalink to this headline">¶</a></h3>
<p>In the transsient grating experiment a laser pulse is split into two parts and recombined in a sample and so produces a grating from which a probe laser can be diffracted. The grating dies away depending on excited state lifetime and linear and rotational diffusion. See Chapter 10.10 for a digram and details.</p>
<p>an initial concentration of <span class="math notranslate nohighlight">\(C\)</span> has to be present at zero time which means defining <span class="math notranslate nohighlight">\(C \gt 0\)</span> and the form the concentration profile will take vs. position <span class="math notranslate nohighlight">\(x\)</span>.  For illustration we assume this profile is the function  <span class="math notranslate nohighlight">\(a+b\cos(kx)\)</span>. This has the form expected in a transient grating experiment, which can be used to measure the diffusion coefficient of electronically excited states.  In these type of experiments a polarised laser pulse is split into two parts and recombined in a solution containing molecules that will absorb this light. As the beams are from the same source they are ‘in phase’ and will interfere at the sample producing strips of excited molecules separated by strips of unexcited ones. This grating is ‘transient’ because molecules diffuse and also because the excited states decay away. A third probe laser is used to scatter light off the transient grating and measures how quickly this decays away. In fluid solution rotational diffusion of the molecules primarily washes out the grating, whereas if this is not possible linear diffusion will do this but on a much longer time scale. A thermal grating may also be present if absorption is into a solid substrate.  Figure 30f in chapter 10 ( differential equations section 10) shows a possible experimental set-up.</p>
<p>Before the calculation can start the dimensions in space and time have to be worked out. As a laser wavelength is measure in nanometres it seems sensible to use this as a unit of distance. The grating wavelength formed by the intersection of the two laser beams has wavelength <span class="math notranslate nohighlight">\(\Lambda=\lambda/2\cos(\theta/2)\)</span>. Using a <span class="math notranslate nohighlight">\(532\)</span> nm laser and an angle of <span class="math notranslate nohighlight">\(20\)</span> degrees between beams produces a value of <span class="math notranslate nohighlight">\(\Lambda \approx 46\)</span> nm. The initial grating will have the form <span class="math notranslate nohighlight">\(c_{00}+\cos(2kx)\)</span> where <span class="math notranslate nohighlight">\(x\)</span> is in nm and <span class="math notranslate nohighlight">\(k=\pi/\Lambda\)</span>. The population <span class="math notranslate nohighlight">\(c_{00}\)</span> is that in the sample where no grating is present but molecules are excited and we chose this to be (<span class="math notranslate nohighlight">\(c_{00}=2\)</span>). Outside the region where the grating is formed the concentration of excited molecules zero and as a result an area larger than the grating is used in the calculation. The reason for doing this is that as time progresses the excited molecules can diffuse into this unexcited area.</p>
<p>The diffusion constant is normally quoted in units of <span class="math notranslate nohighlight">\(\mathrm{m^2\,s^{-1}}\)</span> which is changed into <span class="math notranslate nohighlight">\(\mathrm{nm^2\,ns^{-1}}\)</span> in the calculation meaning that the unit of time is nanoseconds. Because of the limit on the increments, which is that <span class="math notranslate nohighlight">\(\displaystyle \frac{D\Delta t}{(\Delta x)^2} \le 1/2\)</span>, the time step is calculated using this formula. A smaller value could be used if preferred. This means that only <span class="math notranslate nohighlight">\(\Delta x\)</span> need to be chosen and so the concentration plots below always have the same shape but correspond to different times if a different <span class="math notranslate nohighlight">\(\Delta x\)</span> is chosen. It is clear that if too large a value is chosen that the calculation fails, this is observed as oscillations and unrealistic behaviour in the concentration, and illustrates that great care has always to be exercised in choosing parameter values in numerical calculations.</p>
<p>As a thought experiment we imagine that as time progresses the grating should become washed out which is what the calculation shows. If the calculation continues for a very long time then a constant population across the whole region is produced, but only if the Neumann limiting condition is applied, because no excited state decay was included and the total concentration is held constant.</p>
<p>If a reaction such as <span class="math notranslate nohighlight">\(d[C]/dt =-k[C]\)</span> were to be included then the updating equation has the additional rate term,</p>
<div class="math notranslate nohighlight">
\[\displaystyle C_i^{new} = C_i^{old} + \frac{D\Delta t}{(\Delta x)^2}\left(  C_{i+1}^{old}-2C_i^{old} +C_{i-1}^{old}  \right) -kC_i^{old}\Delta t \]</div>
<p>where <span class="math notranslate nohighlight">\(k\)</span> is the rate constant and <span class="math notranslate nohighlight">\(\Delta t\)</span> the time increment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Algorithm 13a; 1D diffusion of a sinusoidal population as in a transient grating experiment</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>        <span class="c1"># set font size for plots</span>

<span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">230</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">)]</span>  <span class="c1"># make axes to plot</span>

<span class="n">Lambda</span> <span class="o">=</span> <span class="p">(</span><span class="mf">530e-9</span> <span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">360</span><span class="p">)</span><span class="o">*</span><span class="mf">1e9</span> <span class="c1"># 530 nm light grating wavelength in nm</span>
<span class="n">w</span>  <span class="o">=</span>   <span class="mi">20</span><span class="o">*</span><span class="n">Lambda</span>                              <span class="c1"># total calculation width as multiple of grating wavelength</span>
<span class="n">nsteps</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="n">D</span>  <span class="o">=</span> <span class="mf">1e-8</span><span class="o">*</span><span class="mf">1e18</span><span class="o">/</span><span class="mf">1e9</span>                            <span class="c1"># diffusion cofff   m^2/s-&gt;1e18/1e9 nm^2/ns </span>
<span class="n">dx</span> <span class="o">=</span> <span class="mf">0.7</span>                                      <span class="c1"># step length nm</span>
<span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">w</span><span class="o">/</span><span class="n">dx</span> <span class="p">)</span>                              <span class="c1"># total number of steps</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">D</span><span class="o">/</span><span class="mi">2</span>                                <span class="c1"># time step in nanosec </span>
<span class="n">alphax</span> <span class="o">=</span> <span class="n">D</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span>                           <span class="c1"># constants </span>

<span class="n">c0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span>              <span class="c1"># make arrays </span>
<span class="n">c</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span>
<span class="n">x</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>

<span class="c1">#kk= 0.25e-1                                  # excited state decay </span>
<span class="n">c00</span> <span class="o">=</span> <span class="mi">2</span>                                       <span class="c1"># value when no grating just two lasers</span>
<span class="n">q</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">Lambda</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span>                        <span class="c1"># start grating q, and  nx-q stop grating</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">nx</span><span class="o">-</span><span class="n">q</span><span class="p">):</span>
    <span class="n">c0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c00</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">Lambda</span><span class="p">)</span>   <span class="c1"># initial sinusoidal profile  </span>

<span class="c1">#--------------------</span>
<span class="k">def</span> <span class="nf">update_step</span><span class="p">(</span><span class="n">c0</span><span class="p">):</span>     <span class="c1"># Propagate with forward-difference in time, central-difference in space</span>
    <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c0</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">alphax</span><span class="o">*</span><span class="p">(</span><span class="n">c0</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">c0</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c0</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>   <span class="c1">#  -kk*dt*c0[1:-1]</span>
    <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                            <span class="c1"># Neumann condition   dc/dt=const</span>
    <span class="n">c</span><span class="p">[</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">nx</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">c</span>
<span class="c1">#-------------------</span>

<span class="n">tsteps</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">10</span><span class="o">*</span><span class="n">nsteps</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span>    <span class="c1"># plot at these timesteps</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">c</span>  <span class="o">=</span> <span class="n">update_step</span><span class="p">(</span><span class="n">c0</span><span class="p">)</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="n">c</span>                     <span class="c1"># make copy as starting data for next iteration</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">tsteps</span><span class="p">:</span>            <span class="c1"># plot only at these times</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">Lambda</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mf">3.15</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">w</span><span class="o">/</span><span class="n">Lambda</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">20</span><span class="o">/</span><span class="n">Lambda</span><span class="p">,</span><span class="mf">2.5</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:0.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">dt</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; ns&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
        <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/num-methods-B_14_0.png" src="../../../_images/num-methods-B_14_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="crank-nicholson-method">
<h2>Crank-Nicholson Method<a class="headerlink" href="#crank-nicholson-method" title="Permalink to this headline">¶</a></h2>
<p>The best method to perform 1D diffusion type calculations, including reaction-diffusion, is, according to Prest (Numerical Recipes), the Crank-Nicholson approach as it is second order in time and space. This method is still subject to numerical instability as are all numerical methods. The method is computationally more complex than the approach above. The method uses the stencil shown below and is based on using the trapezoidal rule to perform the integration.</p>
<p><img alt="Drawing" src="_build_/jupyter_execute/chapter-11/num-methods-fig10c.png" /></p>
<p>Figure 10c. Stencil for the Crank-Nicholson calculation. The top three values labelled with <span class="math notranslate nohighlight">\(j+1\)</span> are unknown.</p>
<hr class="docutils" />
<p>The differential equation is expanded in a manner similar to that of eqn. 31b but as better approximation is made to the second derivative. The result is</p>
<div class="math notranslate nohighlight">
\[\displaystyle \frac{C_i^{j+1}-C_i^j}{\Delta t}=\frac{D}{2(\Delta x)^2}\left(\left[C_{i+1}^{j+1}-2C_i^{j+1}+C_{i-1}^{j+1}\right] - \left[C_{i+1}^j-2C_i^j+C_{i-1}^j  \right ]\right)\]</div>
<p>Any rate equations are added at the end of this scheme as  <span class="math notranslate nohighlight">\(-k[C][..]\Delta t+\cdots \)</span> etc.  The solution for a reaction scheme is given in the code below after the method is explained.</p>
<p>To solve the equation it is far easier to convert it into matrix form. This means calculating all the spatial dimension terms before calculating in time. For clarity let</p>
<div class="math notranslate nohighlight">
\[\displaystyle \sigma =\frac{D\Delta t }{2(\Delta x)^2} \]</div>
<p>and its not so obvious, but it becomes clear later on, that it helps to rewrite the equations by collecting terms in <span class="math notranslate nohighlight">\(C^{j+1}\)</span> and in <span class="math notranslate nohighlight">\(C^j\)</span> as</p>
<div class="math notranslate nohighlight">
\[\displaystyle -\sigma C_{i-1}^{j+1}+(1+2\sigma)C_i^{j+1}-\sigma C_{i+1}^{j+1} = \sigma C_{i-1}^{j}+(1-2\sigma)C_i^{j}+\sigma C_{i+1}^{j} + f(C_i^j)\Delta t  \tag{31c}\]</div>
<p>where <span class="math notranslate nohighlight">\(f(C_i^j)\)</span> represent the rate equations. The tri-diagonal form the the equations can be seen in the <span class="math notranslate nohighlight">\(i-1,\, i,\,i+1\)</span> terms on either side of the equation. However, there is a problem with this because when <span class="math notranslate nohighlight">\(i,j=0\)</span>  there are points are outside the grid, <span class="math notranslate nohighlight">\(C_{-1}\)</span> for example. This can be overcome using the boundary condition that is discretized (under the Neumann condition) to be</p>
<div class="math notranslate nohighlight">
\[\displaystyle \frac{C_0^j-C_{-1}^j}{\Delta x}=0, \qquad \frac{C_m^j-C_{m-1}^j}{\Delta x}=0\]</div>
<p>this leads to the conditions when <span class="math notranslate nohighlight">\(i=0\)</span> that</p>
<div class="math notranslate nohighlight">
\[\displaystyle C_0^j=C_{-1}^j, \; C_0^{j+1}=C_{-1}^{j+1}\]</div>
<p>and when <span class="math notranslate nohighlight">\(i=m-1\)</span></p>
<div class="math notranslate nohighlight">
\[\displaystyle C_{m-1}^j=C_m^j, \; C_{m-1}^{j+1}=C_m^{j+1}\]</div>
<p>The Neumann boundary condition of constant spatial gradient at the limits (in this example the gradient is zero)  prohibits material from entering or leaving across the boundaries; so it is a ‘no flux’ condition.</p>
<p>To solve the equations we have to iterate in time but solve the equations above in spatial coordinates. The best way to do this is to solve for all <span class="math notranslate nohighlight">\(x\)</span> at a given time then increment time and repeat. Although it look very complex, the simplest approach is to transform the equations into matrix form. The concentrations (eqn 31c) can be put into matrix form by defining a column vector,</p>
<div class="math notranslate nohighlight">
\[\displaystyle C^J=\left[ C_0^j,C_1^j\cdots C_{m-1}^j \right]^T\]</div>
<p>and then the ‘tri-diagonal’ matrices for the coefficients in eqn. 31c, including the boundary condition in the first and last rows, are</p>
<div class="math notranslate nohighlight">
\[\begin{split}\displaystyle \begin{align}&amp;\begin{bmatrix}
1+\sigma &amp; -\sigma &amp; 0 &amp; 0 &amp;0&amp; 0\\
-\sigma &amp; 1+2\sigma &amp; -\sigma &amp;0 &amp; 0 &amp;0\\
0 &amp; -\sigma &amp; 1+2\sigma &amp; -\sigma &amp; 0 &amp;0\\
&amp; &amp; \vdots&amp; &amp; &amp;\\
 &amp; &amp;\cdots &amp;-\sigma &amp; 1+2\sigma &amp;-\sigma \\
&amp; &amp; &amp;\cdots &amp;-\sigma &amp; 1+\sigma 
\end{bmatrix} 
\begin{bmatrix}
C_0^{j+1}\\
C_1^{j+1}\\
 \\
\vdots\\
C_{m-1}^{j+1}
\end{bmatrix} =\\&amp; 
\begin{bmatrix}
1-\sigma &amp; +\sigma &amp; 0 &amp; 0 &amp;0&amp; 0\\
+\sigma &amp; 1-2\sigma &amp; +\sigma &amp;0 &amp; 0 &amp;0\\
0 &amp; +\sigma &amp; 1-2\sigma &amp; +\sigma &amp; 0 &amp;0\\
&amp; &amp; \vdots&amp; &amp; &amp;\\
 &amp; &amp;\cdots &amp;+\sigma &amp; 1-2\sigma &amp;+\sigma \\
&amp; &amp; &amp;\cdots &amp;+\sigma &amp; 1-\sigma 
\end{bmatrix} 
\begin{bmatrix}
C_0^{j}\\
C_1^{j}\\
 \\
\vdots\\
C_{m-1}^{}
\end{bmatrix}
+ 
\begin{bmatrix}
f(C_0^{j})\Delta t\\
f(C_1^{j})\Delta t\\
 \\
\vdots\\
f(C_{m-1}^{j}\Delta t
\end{bmatrix}\end{align}\end{split}\]</div>
<p>and in matrix notation this is</p>
<div class="math notranslate nohighlight">
\[\displaystyle  \mathbf{A C}^{j+1} = \mathbf{B C}^{j} + \mathbf{F}\]</div>
<p>Multiplying both sides by <span class="math notranslate nohighlight">\(\mathbf{A^{-1}}\)</span> gives</p>
<div class="math notranslate nohighlight">
\[\displaystyle  \mathbf{C}^{j+1} = \mathbf{A^{-1}}\left(\mathbf{B C}^{j} + \mathbf{F} \right)  \tag{31d}\]</div>
<p>thus in the iteration scheme the <span class="math notranslate nohighlight">\(\mathbf A\)</span> matrix needs to be inverted once only which saves considerable effort. The matrix <span class="math notranslate nohighlight">\(\pmb F\)</span> contains the rate expressions. Time in the numerical model has index <span class="math notranslate nohighlight">\(j\)</span> so once initial values are determined, a loop with the matrix equation can be performed. Note that <span class="math notranslate nohighlight">\(\mathbf{A}^{-1}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{B}\)</span> are constant in time so are evaluated once outside the time loop. Only the <span class="math notranslate nohighlight">\(f\)</span> and <span class="math notranslate nohighlight">\(\mathbf{C}\)</span> vectors vary in time.</p>
<p>As an example we use the Michaelis-Menten scheme. <span class="math notranslate nohighlight">\(S\)</span> is the substrate,<span class="math notranslate nohighlight">\(E\)</span> the enzyme and <span class="math notranslate nohighlight">\(ES\)</span> the complex formed. The product into which the substrate is changed is <span class="math notranslate nohighlight">\(P\)</span>.  To generate the spatial dimension we shall suppose that the reactants are initially in separate microchannels at the end of which they form laminar flow with the enzyme between layers of substrate. The molecules  are able to mix by each diffusing into the other where they react. Naturally, there is an interplay between rate of diffusion and rate of reaction. Figure 10c shows a possible arrangement.</p>
<div class="math notranslate nohighlight">
\[\begin{split}\displaystyle \begin{align}  
S+E &amp;\underset{k_-1}{\stackrel{k_1} \leftrightharpoons} ES\stackrel {k_2}\longrightarrow E+P\\
\frac{d[E]}{dt} &amp;= -k_1[S][E] + (k_{-1}+k_2)[ES] \\
\frac{d[S]}{dt} &amp;= -k_1[S][E] + k_{-1}[ES]\\
\frac{d[ES]}{dt}&amp;= -(k_{-1} + k_2)[ES] + k_1[S][E] \\
\frac{d[P]}{dt} &amp;=  k_2[ES] 
\end{align}\end{split}\]</div>
<p>The  terms to use in the diffusion  equation (equation <span class="math notranslate nohighlight">\(31a\)</span> )  are the right hand sides of the rate equations. And as we have four species there are four similar diffusion equations to be calculated. Clearly, the diffusion coefficient in the solvent used has to be known for each species as do all the rate constants.</p>
<p><img alt="Drawing" src="_build_/jupyter_execute/chapter-11/num-methods-fig10d.png" /></p>
<p>Figure 10d. Schematic for microchannel reaction. The reactants are in separate microchannels (grey) on the left which opens into a larger single channel. As they flow the fluids react and diffuse together.The entrance width of a channel is typically <span class="math notranslate nohighlight">\(50\)</span> microns. The enzyme is flowing down the centre of the channel (red). The measurement is made at different points across the channels corresponding to different times.</p>
<hr class="docutils" />
<p>The calculation is shown below. The initial concentrations are in the first two plots in the top line and the results at later times below these. The intermediate ES is shown in the third plot and the concentrations vs. time measured just in the narrow channel is shown below this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Algorithm 13b Crank-Nicholson</span>

<span class="c1"># reaction diffusion  Crank_Nicolson + chemistry</span>

<span class="c1"># S+Ez &lt;=&gt; ES -&gt; Ez+P,  k1, (km1), k2 .   </span>
<span class="c1"># dEz/dt = -k1.S.Ez + (km1+k2).ES, </span>
<span class="c1"># dS/dt  =  -k1.S.Ez + km1.ES ,</span>
<span class="c1"># dES/dt = -(k2+km1).ES + k1.S.Ez , </span>
<span class="c1"># dU/dt  = D_u(d^2U/dx^2) - f(rate expression) for each species </span>
<span class="c1"># use time in microsec , distances in micrometres.</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>  <span class="c1"># set font size for plots</span>

<span class="n">fig1</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>        <span class="c1"># set plot window and 2 rows 3 cols sub plots</span>
<span class="n">ax0</span> <span class="o">=</span> <span class="n">fig1</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig1</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig1</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig1</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">ax4</span> <span class="o">=</span> <span class="n">fig1</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">ax5</span> <span class="o">=</span> <span class="n">fig1</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="c1">#-----------------------------------</span>
<span class="k">def</span> <span class="nf">do_calc</span><span class="p">():</span>

    <span class="c1">#---------</span>
    <span class="k">def</span> <span class="nf">Ezvec</span><span class="p">(</span><span class="n">Ez</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">ES</span><span class="p">):</span>                                    <span class="c1"># vector for chemistry dEz/dt  </span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">J</span> <span class="p">):</span>
            <span class="n">avec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">Ez</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">km1</span><span class="o">+</span><span class="n">k2</span><span class="p">)</span><span class="o">*</span><span class="n">ES</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>      <span class="c1"># rate constants defined in outside.</span>
        <span class="k">return</span> <span class="n">avec</span><span class="o">*</span><span class="n">dt</span>    
    <span class="c1">#---------</span>
    
    <span class="k">def</span> <span class="nf">Svec</span><span class="p">(</span><span class="n">Ez</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">ES</span><span class="p">):</span>                                     <span class="c1"># chemistry dS/dt  </span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">J</span> <span class="p">):</span>
            <span class="n">avec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">Ez</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">km1</span><span class="o">*</span><span class="n">ES</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>           <span class="c1"># rate constants defined in outside.</span>
        <span class="k">return</span> <span class="n">avec</span><span class="o">*</span><span class="n">dt</span>    
    <span class="c1">#---------</span>
    
    <span class="k">def</span> <span class="nf">ESvec</span><span class="p">(</span><span class="n">Ez</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">ES</span><span class="p">):</span>                                    <span class="c1"># chemistrty dES/dt</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">J</span> <span class="p">):</span>
            <span class="n">avec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k1</span><span class="o">*</span><span class="n">Ez</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">k2</span><span class="o">+</span><span class="n">km1</span><span class="p">)</span><span class="o">*</span><span class="n">ES</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">avec</span><span class="o">*</span><span class="n">dt</span>   
    <span class="c1">#---------</span>
    
    <span class="k">def</span> <span class="nf">make_tri_matrix</span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="n">Q</span><span class="p">):</span>           <span class="c1"># matrix is symmetrical when ss=2, or 1st/last row ss=1</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="mf">1.0</span>  
        <span class="n">M</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">J</span><span class="p">,</span><span class="n">J</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ss</span><span class="o">*</span><span class="n">Q</span>
        <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">Q</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">Q</span>
            <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Q</span>
            <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">Q</span>
            <span class="k">pass</span>
        <span class="n">M</span><span class="p">[</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">J</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span><span class="n">Q</span>
        <span class="n">M</span><span class="p">[</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ss</span><span class="o">*</span><span class="n">Q</span>
        
        <span class="k">return</span> <span class="n">M</span>
    <span class="c1">#----------</span>
    
    <span class="k">def</span> <span class="nf">pretty_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span><span class="n">ymax</span><span class="p">,</span> <span class="n">atext</span><span class="p">,</span> <span class="n">colr</span><span class="p">):</span>   <span class="c1"># put common features here</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.1</span><span class="o">*</span><span class="n">ymax</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;concentration&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">atext</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="n">x0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="n">x1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">colr</span><span class="p">)</span>
        <span class="k">pass</span>
    <span class="c1">#-----------------------</span>
                       <span class="c1">#  constants etc </span>
    
    <span class="n">ms</span> <span class="o">=</span> <span class="mf">1e-6</span>          <span class="c1"># scale microseconds &amp; micrometres</span>
    <span class="n">L</span>  <span class="o">=</span> <span class="mf">100.0</span><span class="o">*</span><span class="n">ms</span>      <span class="c1"># total width in dm :  30*ms = 3 micrometres</span>
    <span class="n">J</span>  <span class="o">=</span> <span class="mi">200</span>           <span class="c1"># number spatial points </span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">L</span><span class="o">/</span><span class="p">(</span><span class="n">J</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> 
    
    <span class="n">T</span>  <span class="o">=</span> <span class="mf">100000.0</span><span class="o">*</span><span class="n">ms</span>   <span class="c1"># total time  seconds </span>
    <span class="n">N</span>  <span class="o">=</span> <span class="mi">10000</span>         <span class="c1"># number of time points</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">T</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> 
    
    <span class="n">DS</span>  <span class="o">=</span> <span class="mf">1e-2</span><span class="o">*</span><span class="n">ms</span>      <span class="c1"># diff coeffs dm^2/s  substrate   1e-6 cm^2/s == 1e-10 m^2/s == 1e-8 dm^2/s</span>
    <span class="n">DEz</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="o">*</span><span class="n">ms</span>      <span class="c1"># enzyme diffn coeff smaller than substrate as it is big</span>
    <span class="n">DES</span> <span class="o">=</span> <span class="mf">1.00</span> <span class="o">*</span> <span class="n">DEz</span>   <span class="c1"># same as enzyme</span>
    
    <span class="n">k1</span>  <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span><span class="n">ms</span>      <span class="c1">#  2 nd order rate const   dm^3/mol/s -&gt; E+S</span>
    <span class="n">km1</span> <span class="o">=</span> <span class="mf">0.02</span><span class="o">/</span><span class="n">ms</span>      <span class="c1">#  1 st order 1/s reverse reaction</span>
    <span class="n">k2</span>  <span class="o">=</span> <span class="mf">0.01</span> <span class="o">/</span><span class="n">ms</span>     <span class="c1">#  1 st order ES to product</span>
    <span class="n">kk</span>  <span class="o">=</span> <span class="n">km1</span> <span class="o">+</span> <span class="n">k2</span>     <span class="c1">#  allow for ES to react to product </span>
    
    <span class="n">S0</span>  <span class="o">=</span> <span class="mf">1.0e-2</span>       <span class="c1"># initial concentrations  </span>
    <span class="n">Ez0</span> <span class="o">=</span> <span class="mf">1.0e-3</span>
    <span class="n">ES0</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="c1">#------------------------</span>
    
    <span class="n">SEz</span> <span class="o">=</span> <span class="n">DEz</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>    <span class="c1"># scaling params in eqns</span>
    <span class="n">SS</span> <span class="o">=</span>  <span class="n">DS</span> <span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
    <span class="n">SE</span> <span class="o">=</span>  <span class="n">DES</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1"> </span><span class="si">{:8.3g}</span><span class="s1"> </span><span class="si">{:8.3g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;dx,dt&#39;</span><span class="p">,</span><span class="n">dx</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span> <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1"> </span><span class="si">{:10.5g}</span><span class="s1"> </span><span class="si">{:10.5g}</span><span class="s1"> </span><span class="si">{:10.5g}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;k1, km1, k2  &#39;</span><span class="p">,</span><span class="n">k1</span><span class="p">,</span><span class="n">km1</span><span class="p">,</span><span class="n">k2</span><span class="p">)</span> <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1"> </span><span class="si">{:10.5g}</span><span class="s1"> </span><span class="si">{:10.5g}</span><span class="s1"> </span><span class="si">{:10.5g}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;DS, DEz, DES &#39;</span><span class="p">,</span><span class="n">DS</span><span class="p">,</span> <span class="n">DEz</span><span class="p">,</span> <span class="n">DES</span> <span class="p">)</span> <span class="p">)</span>
    
    <span class="c1"># make initial profiles</span>
    <span class="n">tgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>  <span class="c1"># time grid points</span>
    <span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">J</span><span class="p">)</span>  <span class="c1"># spatial grid</span>
    
    <span class="n">Ez</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">ES</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="n">avec</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>   <span class="c1"># used to set up A, B matrices</span>
    <span class="n">S</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>   <span class="c1"># used just for pics</span>
    
    <span class="c1">#  set channels and init conc&#39;ns Ez, S</span>
    <span class="n">dwidth</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">xf0</span> <span class="o">=</span> <span class="mf">0.45</span>                      <span class="c1"># set start as fractional width of channel</span>
    <span class="n">xf1</span> <span class="o">=</span> <span class="n">xf0</span> <span class="o">+</span> <span class="n">dwidth</span>              <span class="c1"># set fractional increment</span>
    <span class="n">indx0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">indx1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">J</span><span class="p">):</span>              <span class="c1"># set width of channel </span>
        <span class="n">Ez</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">S0</span>
        <span class="k">if</span> <span class="n">xgrid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xf0</span><span class="o">*</span><span class="n">L</span><span class="p">:</span>
            <span class="n">indx0</span> <span class="o">=</span> <span class="n">indx0</span> <span class="o">+</span> <span class="mi">1</span>   
        <span class="k">if</span> <span class="n">xgrid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xf0</span><span class="o">*</span><span class="n">L</span> <span class="ow">and</span> <span class="n">xgrid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xf1</span><span class="o">*</span><span class="n">L</span><span class="p">:</span>
            <span class="n">Ez</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ez0</span>
            <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">indx1</span> <span class="o">=</span> <span class="n">indx1</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">pass</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">indx0</span>                      <span class="c1"># index of right side area.    </span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">indx0</span> <span class="o">+</span> <span class="n">indx1</span> 
    <span class="k">if</span> <span class="n">x1</span> <span class="o">&gt;=</span> <span class="n">J</span><span class="p">:</span> 
        <span class="n">x1</span> <span class="o">=</span> <span class="n">J</span><span class="o">-</span><span class="mi">1</span>
        
    <span class="n">pretty_plot</span><span class="p">(</span><span class="n">ax0</span><span class="p">,</span><span class="n">xgrid</span><span class="o">/</span><span class="n">ms</span><span class="p">,</span><span class="n">Ez</span><span class="p">,</span><span class="n">Ez0</span><span class="p">,</span><span class="s1">&#39;Ez initial&#39;</span><span class="p">,</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>             <span class="c1"># plot initial profiles</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xgrid</span><span class="o">/</span><span class="n">ms</span><span class="p">,</span> <span class="n">Ez</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">pretty_plot</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span><span class="n">xgrid</span><span class="o">/</span><span class="n">ms</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">S0</span><span class="p">,</span><span class="s1">&#39;S initial&#39;</span><span class="p">,</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
    <span class="n">pretty_plot</span><span class="p">(</span><span class="n">ax4</span><span class="p">,</span><span class="n">xgrid</span><span class="o">/</span><span class="n">ms</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">S0</span><span class="p">,</span><span class="s1">&#39;S vs. time&#39;</span><span class="p">,</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xgrid</span><span class="o">/</span><span class="n">ms</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">color</span><span class="o">=</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">pretty_plot</span><span class="p">(</span><span class="n">ax3</span><span class="p">,</span><span class="n">xgrid</span><span class="o">/</span><span class="n">ms</span><span class="p">,</span><span class="n">Ez</span><span class="p">,</span><span class="n">Ez0</span><span class="p">,</span><span class="s1">&#39;Ez vs. time&#39;</span><span class="p">,</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">pretty_plot</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span><span class="n">xgrid</span><span class="o">/</span><span class="n">ms</span><span class="p">,</span><span class="n">ES</span><span class="p">,</span><span class="n">Ez0</span><span class="p">,</span><span class="s1">&#39;ES x 10 vs. time&#39;</span><span class="p">,</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
    
    <span class="c1"># end set channels and plotting</span>
    
    <span class="n">AEz</span> <span class="o">=</span> <span class="n">make_tri_matrix</span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="n">SEz</span><span class="p">)</span>          <span class="c1">#set up tri diagonal matrices </span>
    <span class="n">AS</span>  <span class="o">=</span> <span class="n">make_tri_matrix</span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="n">SS</span><span class="p">)</span>
    <span class="n">AES</span> <span class="o">=</span> <span class="n">make_tri_matrix</span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="n">SE</span><span class="p">)</span>
    <span class="n">BEz</span> <span class="o">=</span> <span class="n">make_tri_matrix</span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="o">-</span><span class="n">SEz</span><span class="p">)</span>
    <span class="n">BS</span>  <span class="o">=</span> <span class="n">make_tri_matrix</span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="o">-</span><span class="n">SS</span><span class="p">)</span>
    <span class="n">BES</span> <span class="o">=</span> <span class="n">make_tri_matrix</span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="o">-</span><span class="n">SE</span><span class="p">)</span>
    
    <span class="n">Ezall</span> <span class="o">=</span> <span class="p">[]</span>                            <span class="c1"># initialise list used to hold data</span>
    <span class="n">Sall</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ESall</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">Ezall</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ez</span><span class="p">)</span>                      <span class="c1"># store values</span>
    <span class="n">Sall</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
    <span class="n">ESall</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ES</span><span class="p">)</span>

    <span class="n">invAEz</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">AEz</span><span class="p">)</span>             <span class="c1"># invert matrices only once</span>
    <span class="n">invAS</span>  <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">AS</span><span class="p">)</span> 
    <span class="n">invAES</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">AES</span><span class="p">)</span>
   
    <span class="c1">#print(&#39;starting calc&#39;)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>                 <span class="c1"># main calculation: iteration in time</span>
        <span class="c1">#dt = tgrid[i]-tgrid[i-1]        # equivalent time used if log time scale used</span>
        <span class="n">Eznew</span> <span class="o">=</span> <span class="n">invAEz</span> <span class="o">@</span> <span class="p">(</span> <span class="n">BEz</span> <span class="o">@</span> <span class="n">Ez</span> <span class="o">+</span> <span class="n">Ezvec</span><span class="p">(</span> <span class="n">Ez</span><span class="p">,</span><span class="n">S</span><span class="p">,</span> <span class="n">ES</span><span class="p">)</span> <span class="p">)</span>  <span class="c1"># @ is matrix multiply</span>
        <span class="n">Snew</span>  <span class="o">=</span> <span class="n">invAS</span>  <span class="o">@</span> <span class="p">(</span> <span class="n">BS</span>  <span class="o">@</span> <span class="n">S</span>  <span class="o">+</span> <span class="n">Svec</span><span class="p">(</span> <span class="n">Ez</span><span class="p">,</span><span class="n">S</span><span class="p">,</span> <span class="n">ES</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">ESnew</span> <span class="o">=</span> <span class="n">invAES</span> <span class="o">@</span> <span class="p">(</span> <span class="n">BES</span> <span class="o">@</span> <span class="n">ES</span> <span class="o">+</span> <span class="n">ESvec</span><span class="p">(</span> <span class="n">Ez</span><span class="p">,</span><span class="n">S</span><span class="p">,</span> <span class="n">ES</span><span class="p">)</span> <span class="p">)</span>   
        
        <span class="n">Ez</span> <span class="o">=</span> <span class="n">Eznew</span>
        <span class="n">S</span>  <span class="o">=</span> <span class="n">Snew</span>
        <span class="n">ES</span> <span class="o">=</span> <span class="n">ESnew</span>
        
        <span class="k">if</span>  <span class="n">i</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>         <span class="c1"># plot multiples of N/20</span>
            <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xgrid</span><span class="o">/</span><span class="n">ms</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>  <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xgrid</span><span class="o">/</span><span class="n">ms</span><span class="p">,</span> <span class="n">Ez</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>  <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xgrid</span><span class="o">/</span><span class="n">ms</span><span class="p">,</span> <span class="n">ES</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">pass</span>
        <span class="n">Ezall</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ez</span><span class="p">)</span>
        <span class="n">Sall</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
        <span class="n">ESall</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ES</span><span class="p">)</span>
        <span class="k">pass</span>
    <span class="c1">#print(&#39;finished calculation - plotting&#39;)</span>
    
    <span class="n">Ezsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">ESsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
   
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>                       <span class="c1"># N time points</span>
        <span class="n">Ezsum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Ezall</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span> <span class="p">])</span><span class="o">*</span><span class="n">dwidth</span>  <span class="c1"># sum over central region only</span>
        <span class="n">ESsum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ESall</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span> <span class="p">])</span><span class="o">*</span><span class="n">dwidth</span> 
    
    <span class="n">Ezmx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Ezsum</span><span class="p">)</span>
    <span class="n">ESmx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ESsum</span><span class="p">)</span>
    
    
    <span class="n">ax5</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.2</span><span class="o">*</span><span class="n">Ezsum</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>   <span class="c1"># log time</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tgrid</span><span class="p">,</span><span class="n">Ezsum</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ez&#39;</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tgrid</span><span class="p">,</span><span class="n">ESsum</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;ES&#39;</span><span class="p">)</span>
    
    <span class="n">ax5</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ES, Ez&#39;</span><span class="p">)</span>    
    <span class="n">ax5</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time/ s&#39;</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39; ES, Ez&#39;</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
      
    <span class="n">astr1</span> <span class="o">=</span><span class="s1">&#39;$k_1=$&#39;</span><span class="o">+</span><span class="s1">&#39; </span><span class="si">{:10.4g}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">k1</span><span class="p">)</span>  <span class="p">)</span> <span class="c1"># use Mathjax in $  ... $ to prettyfy</span>
    <span class="n">astr2</span> <span class="o">=</span><span class="s1">&#39;$k_{-1}=$&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{:10.4g}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">km1</span><span class="p">)</span>  <span class="p">)</span>
    <span class="n">astr3</span> <span class="o">=</span><span class="s1">&#39;$k_2=$&#39;</span><span class="o">+</span><span class="s1">&#39; </span><span class="si">{:10.4g}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">k2</span><span class="p">)</span>  <span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">astr1</span><span class="o">+</span><span class="n">astr2</span><span class="o">+</span><span class="n">astr3</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span> <span class="p">(</span><span class="n">xgrid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">Ezsum</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="p">)</span>
    <span class="k">pass</span>   <span class="c1"># end of do_calc</span>

<span class="c1">#----------------------------  end of main def do_calc()</span>

<span class="n">do_calc</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dx,dt 5.03e-07    1e-05
k1, km1, k2        5e+05      20000      10000 
DS, DEz, DES       1e-08      1e-09      1e-09 
</pre></div>
</div>
<img alt="../../../_images/num-methods-B_17_1.png" src="../../../_images/num-methods-B_17_1.png" />
</div>
</div>
</div>
<div class="section" id="d-diffusion-in-a-plate">
<h2>2D diffusion in a plate.<a class="headerlink" href="#d-diffusion-in-a-plate" title="Permalink to this headline">¶</a></h2>
<p>Returning to using the simpler integration scheme described at the start of this section but now  in two dimensions. The reason for using the simpler scheme is because the 2D Crank-Nicholson scheme produces equations that are hard to solve and alternative, and complicated,  methods as described by Prest et al. (Numerical Recipes) are then used.</p>
<p>The two-dimensional diffusion equation is</p>
<div class="math notranslate nohighlight">
\[\frac{\partial U}{\partial t}=D\left(  \frac{\partial^2 U }{\partial x^2 }+\frac{\partial ^2U }{\partial y^2}\right) \]</div>
<p>where <span class="math notranslate nohighlight">\(U\)</span> represents temperature of concentration as necessary. Since there no terms involving both <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> the two dimensions can be treated separately and this greatly simplifies the calculation. It is also assumed that the diffusion coefficient is the same in all directions and is constant as the temperature changes, which implies that any temperature change must be small.</p>
<p>A numerical solution on the domain of the unit square <span class="math notranslate nohighlight">\(0 \le x \lt 1,\;0\le y \lt 1\)</span> approximates <span class="math notranslate nohighlight">\(U(x,y;t)\)</span> by the discrete function <span class="math notranslate nohighlight">\(u^{n}_{i,j}\)</span> where <span class="math notranslate nohighlight">\(x=i\Delta x, y=j\Delta y , t = n\Delta t\)</span>. If a unit square is not what is required then we suppose that <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> are fractions of the true dimensions and adjust the graphs plotted at the end as appropriate.  Applying finite difference approximations yields</p>
<div class="math notranslate nohighlight">
\[\frac{u^{(n+1)}_{i,j}- u^{n}_{i,j}}{Δt} =D\left( \frac{u^{n}_{i+1,j}- 2u^{n}_{i,j} + u^{n}_{i-1,j}}{\Delta x^2} +\frac{u^{n}_{i+1,j}- 2u^{n}_{i,j} + u^{n}_{i-1,j}}{\Delta y^2}\right) \]</div>
<p>and hence time step <span class="math notranslate nohighlight">\(n+1, u^{(n+1)}_{i,j}\)</span> may be calculated from its state at time step <span class="math notranslate nohighlight">\(n, u^{n}_{i,j}\)</span> through this  equation by separating out as was done in one dimension</p>
<div class="math notranslate nohighlight">
\[u^{(n+1)}_{i,j}= u^n_{i,j}+D\Delta t \left( \cdots \right)\]</div>
<p>Consider the diffusion equation applied to a plate initially at temperature <span class="math notranslate nohighlight">\(T_0\)</span> apart from a disc of a specified size which is at temperature <span class="math notranslate nohighlight">\(T_1\)</span>. We suppose that the edges of the plate are held fixed at <span class="math notranslate nohighlight">\(T_0\)</span>. Experimentally this might correspond to heating a spot in a thin sample with pulse from a laser and then observing the change in temperature. A related experiment is to ablate a region in a cell membrane into which a protein of other molecule is labelled with a fluorescent dye. The ablation is such that it bleaches the dye without appreciably heating the sample, and then the re-appearance of the fluorescence is monitored after the ablating laser pulse has ended. This then produced the diffusion coefficient of the labelled molecules. This is  what occurs in a FRAP (Fluorescence Recovery after Photo-bleaching) experiment.</p>
<p>The following code applies the above formula to follow the evolution of the temperature of a plate. The initial spot is heated with respect to the rest of the plate. The code used is similar to that given above in the subroutine ‘update_step’.</p>
<p>It can be shown that the maximum time step, <span class="math notranslate nohighlight">\(\Delta t\)</span>% that we can allow without the process becoming unstable is</p>
<div class="math notranslate nohighlight">
\[\displaystyle \Delta t=\frac{(\Delta x\Delta y)^2}{2D(\Delta x^2+\Delta y^2)}\]</div>
<p>The Neumann initial condition is used and ensures that no heat is lost, which can be checked by summing the total temperature of the plate at different times.  The images clearly show how the energy deposited into the central spot diffuses into the surroundings as time passes. Calculating the temperature  at the centre of the disc (or at any other position) indicates how the energy spreads with time.  The average distance heat or molecules diffuse in time <span class="math notranslate nohighlight">\(t\)</span> is given by <span class="math notranslate nohighlight">\(\langle r\rangle =\sqrt{2nDt}\)</span> in dimension <span class="math notranslate nohighlight">\(n\)</span> thus <span class="math notranslate nohighlight">\(\langle r\rangle =\sqrt{4Dt}\)</span> in this example. These average distances are shown on the plots and show how the radial distance diffused slows down in time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Algorithm 13b; 2D diffusion in a plate</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span>  <span class="c1"># set font size for plots</span>

<span class="n">w</span><span class="p">,</span> <span class="n">h</span>  <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span>               <span class="c1">#  keep fixed plate size unity mm.</span>
<span class="n">dx</span><span class="p">,</span><span class="n">dy</span> <span class="o">=</span> <span class="mf">0.002</span><span class="p">,</span> <span class="mf">0.002</span>          <span class="c1"># intervals in x-, y- directions, mm</span>
<span class="n">D</span>     <span class="o">=</span> <span class="mf">0.08</span>                  <span class="c1"># 0.08 mm^2/s typical of organic liquid,  Thermal diffusivity</span>

<span class="n">Tcool</span><span class="p">,</span> <span class="n">Thot</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">310</span>        <span class="c1"># plate temperaqture and init temp in heated area</span>
<span class="n">nsteps</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="o">/</span><span class="n">dx</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="o">/</span><span class="n">dy</span><span class="p">)</span>
<span class="n">dx2</span> <span class="o">=</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span>
<span class="n">dy2</span> <span class="o">=</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span>
<span class="n">dt</span>  <span class="o">=</span> <span class="n">dx2</span> <span class="o">*</span> <span class="n">dy2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="p">(</span><span class="n">dx2</span> <span class="o">+</span> <span class="n">dy2</span><span class="p">))</span>  <span class="c1"># time in seconds </span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1"> </span><span class="si">{:g}</span><span class="s1"> </span><span class="si">{:s}</span><span class="s1"> </span><span class="si">{:g}</span><span class="s1"> </span><span class="si">{:s}</span><span class="s1"> </span><span class="si">{:g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;dx &#39;</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span><span class="s1">&#39;dy &#39;</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="s1">&#39;dt &#39;</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span> <span class="p">)</span>
<span class="n">alphax</span> <span class="o">=</span> <span class="n">D</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="n">dx2</span>
<span class="n">alphay</span> <span class="o">=</span> <span class="n">D</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="n">dy2</span>

<span class="n">u0</span> <span class="o">=</span> <span class="n">Tcool</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span>       <span class="c1"># initial values everywhere</span>
<span class="n">u</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">),</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span>
<span class="n">p</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">nsteps</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># Initial conditions - ring of inner radius r (mm), width dr centred at (cx,cy) (mm), r &gt; dx</span>
<span class="n">r</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">h</span>
<span class="n">r2</span> <span class="o">=</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;spot radius&#39;</span><span class="p">,</span><span class="n">r</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span><span class="s1">&#39; micron&#39;</span><span class="p">)</span>

<span class="c1">#--------------------</span>
<span class="k">def</span> <span class="nf">hot_spot</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span><span class="n">Thot</span><span class="p">):</span>                     <span class="c1"># check where to pot hot molecules</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">dx</span><span class="o">-</span><span class="n">cx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="n">dy</span><span class="o">-</span><span class="n">cy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># in mm</span>
            <span class="k">if</span> <span class="n">p2</span> <span class="o">&lt;=</span> <span class="n">r2</span><span class="p">:</span>
                <span class="n">u0</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Thot</span>
    <span class="k">return</span> <span class="n">u0</span>        
<span class="c1">#-------------------</span>
<span class="k">def</span> <span class="nf">aring</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">):</span>                        <span class="c1"># returns list of x and y coords of circle in mm</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">360</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span>  <span class="c1"># in mm</span>
            
<span class="c1">#--------------------</span>
<span class="k">def</span> <span class="nf">update_step2D</span><span class="p">(</span><span class="n">u0</span><span class="p">):</span>                     <span class="c1"># Neumann conditions added at end</span>
    <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u0</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">alphax</span><span class="o">*</span><span class="p">(</span><span class="n">u0</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u0</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u0</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> \
                                   <span class="o">+</span> <span class="n">alphay</span><span class="o">*</span><span class="p">(</span><span class="n">u0</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u0</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u0</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> 
    <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>    <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>           <span class="c1"># Neumann limits</span>
    <span class="n">u</span><span class="p">[</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">nx</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>    <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">ny</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">u</span>
<span class="c1">#-------------------</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1"> </span><span class="si">{:g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="s1">&#39;maxtime (ms)&#39;</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="mi">1000</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">xring</span><span class="p">,</span> <span class="n">yring</span> <span class="o">=</span> <span class="n">aring</span><span class="p">(</span> <span class="n">r</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="p">)</span>          <span class="c1"># coords of circle radius r </span>
<span class="n">u0</span> <span class="o">=</span> <span class="n">hot_spot</span><span class="p">(</span> <span class="n">u0</span><span class="p">,</span> <span class="n">Thot</span> <span class="p">)</span>                  <span class="c1"># make initial hot spot</span>
<span class="n">mfig</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">*</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">*</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">*</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">*</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">]</span> <span class="c1"># plot at these timesteps</span>
<span class="n">fignum</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;start calculation&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">u</span>  <span class="o">=</span> <span class="n">update_step2D</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span>
    <span class="n">u0</span> <span class="o">=</span> <span class="n">u</span>                                 <span class="c1">#  make copy as starting data for next iteration</span>
    <span class="n">p</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">nx</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">ny</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mfig</span><span class="p">:</span>                          <span class="c1"># plot only at these times</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;time steps&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="n">fignum</span> <span class="o">=</span> <span class="n">fignum</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">230</span> <span class="o">+</span> <span class="n">fignum</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis_r&#39;</span><span class="p">)</span> <span class="p">,</span> <span class="n">vmin</span> <span class="o">=</span> <span class="n">Tcool</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">Thot</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">nx</span><span class="o">//</span><span class="mi">3</span><span class="p">,</span><span class="n">nx</span><span class="o">*</span><span class="mi">2</span><span class="o">//</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># only show part of plot 1/3 to 2/3 </span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">ny</span><span class="o">//</span><span class="mi">3</span><span class="p">,</span><span class="n">ny</span><span class="o">*</span><span class="mi">2</span><span class="o">//</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">fignum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:6.3g}</span><span class="s1"> </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span><span class="s1">&#39;ms, red ring initial spot&#39;</span><span class="p">)</span>  <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:6.3g}</span><span class="s1"> </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>  <span class="p">)</span>
            
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">1.1</span><span class="o">*</span><span class="n">nx</span><span class="o">//</span><span class="mi">3</span><span class="p">,</span> <span class="mf">1.1</span><span class="o">*</span><span class="n">nx</span><span class="o">//</span><span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.05</span><span class="o">/</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">nx</span><span class="o">//</span><span class="mi">3</span><span class="p">],[</span><span class="mf">1.85</span><span class="o">*</span><span class="n">ny</span><span class="o">//</span><span class="mi">3</span><span class="p">,</span> <span class="mf">1.85</span><span class="o">*</span><span class="n">ny</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>   <span class="c1"># plot bar size 50 micron</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">nx</span><span class="o">//</span><span class="mi">3</span><span class="p">,</span> <span class="n">ny</span><span class="o">*</span><span class="mf">1.9</span><span class="o">//</span><span class="mi">3</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;$\;50\,\mu m$&#39;</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xring</span><span class="o">*</span><span class="n">nx</span><span class="p">,</span> <span class="n">yring</span><span class="o">*</span><span class="n">nx</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">av_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span><span class="o">*</span><span class="mf">1e-6</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span>                <span class="c1"># average distance diffused at this time ( metres)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">nx</span><span class="o">//</span><span class="mi">3</span><span class="p">,</span><span class="mf">1.1</span><span class="o">*</span><span class="n">ny</span><span class="o">//</span><span class="mi">3</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$\;\langle r\rangle =$&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:6.3g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">av_r</span><span class="o">*</span><span class="mf">1e6</span><span class="p">))</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39; $\mu m$&#39;</span><span class="p">)</span>
        <span class="k">pass</span>

<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span> <span class="o">=</span> <span class="mf">0.85</span><span class="p">)</span>
<span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.88</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>
<span class="n">cbar_ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$T$ / K&#39;</span><span class="p">,</span> <span class="n">labelpad</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span> <span class="o">=</span> <span class="n">cbar_ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dx  0.002 dy  0.002 dt  1.25e-05
spot radius 50.0  micron
maxtime (ms) 25
start calculation
time steps 0
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>time steps 400
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>time steps 800
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>time steps 1200
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>time steps 1600
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>time steps 2000
</pre></div>
</div>
<img alt="../../../_images/num-methods-B_19_6.png" src="../../../_images/num-methods-B_19_6.png" />
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./_build_/jupyter_execute/chapter-11"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Godfrey Beddard<br/>
        
            &copy; Copyright 2022.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>